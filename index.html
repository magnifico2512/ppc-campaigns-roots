<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon PPC Campaign Builder V7 - Auto Assign</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .sticky-header { position: sticky; top: 0; z-index: 10; background: white; }
        .table-row:hover { background: #f8fafc; }
        .scrollbar-thin::-webkit-scrollbar { width: 8px; height: 8px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #f1f5f9; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: white;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        function PPCCampaignBuilderV7() {
            const [keywords, setKeywords] = useState([]);
            const [campaigns, setCampaigns] = useState([
                { id: 1, name: 'Campaign 1', matchType: 'Exact', maxKeywords: 30, minVolume: 0, maxVolume: 100000 }
            ]);
            const [showSetup, setShowSetup] = useState(true);
            const [keywordInput, setKeywordInput] = useState('');
            const [existingKeywords, setExistingKeywords] = useState('');
            const [productDescription, setProductDescription] = useState('');
            const [keywordLanguage, setKeywordLanguage] = useState('multi'); // Language of keywords
            const [rootFilter, setRootFilter] = useState(new Set(['all']));
            const [rootSearchFilter, setRootSearchFilter] = useState('');
            const [showRootDropdown, setShowRootDropdown] = useState(false);
            const [searchFilter, setSearchFilter] = useState('');
            const [sortBy, setSortBy] = useState('volume-desc');
            const [smartSuggestions, setSmartSuggestions] = useState([]);
            const [showSuggestions, setShowSuggestions] = useState(true);
            const [selectedKeywords, setSelectedKeywords] = useState(new Set());
            const [lastBulkAssign, setLastBulkAssign] = useState(null);
            const [excludedSuggestions, setExcludedSuggestions] = useState(new Set());
            const [mergeMode, setMergeMode] = useState(true);
            const [brandList, setBrandList] = useState('');
            const [volumeMin, setVolumeMin] = useState('');
            const [volumeMax, setVolumeMax] = useState('');
            const [rootCountMin, setRootCountMin] = useState('');
            const [rootCountMax, setRootCountMax] = useState('');
            const [assignmentFilter, setAssignmentFilter] = useState('all');
            const [campaignFilter, setCampaignFilter] = useState('all');
            const [showAutoAssign, setShowAutoAssign] = useState(false);
            const [autoAssignRootSearch, setAutoAssignRootSearch] = useState('');
            const [autoAssignConfig, setAutoAssignConfig] = useState({
                selectedRoots: new Set(),
                rootConfigs: {},
                rootGroups: [], // Array of {id, name, roots: Set, campaigns: []}
                globalMaxKeywords: '',
                globalMinVolume: '',
                globalMaxVolume: ''
            });
            const [showRestoreDialog, setShowRestoreDialog] = useState(false);
            const [savedStateExists, setSavedStateExists] = useState(false);
            const [customColumns, setCustomColumns] = useState([]);
            const [showColumnManager, setShowColumnManager] = useState(false);
            const [newColumnName, setNewColumnName] = useState('');
            const [tableData, setTableData] = useState([{ term: '', volume: '', custom: {} }]);
            const [selectedRows, setSelectedRows] = useState(new Set());

            // Save state to localStorage
            const saveState = () => {
                try {
                    const stateToSave = {
                        keywords,
                        campaigns,
                        keywordInput,
                        existingKeywords,
                        productDescription,
                        keywordLanguage,
                        brandList,
                        customColumns,
                        tableData,
                        timestamp: new Date().toISOString()
                    };
                    localStorage.setItem('ppcCampaignBuilder_savedState', JSON.stringify(stateToSave));
                } catch (error) {
                    console.error('Error saving state:', error);
                }
            };

            // Load state from localStorage
            const loadState = () => {
                try {
                    const savedState = localStorage.getItem('ppcCampaignBuilder_savedState');
                    if (savedState) {
                        const parsed = JSON.parse(savedState);
                        setKeywords(parsed.keywords || []);
                        setCampaigns(parsed.campaigns || [{ id: 1, name: 'Campaign 1', matchType: 'Exact', maxKeywords: 30, minVolume: 0, maxVolume: 100000 }]);
                        setKeywordInput(parsed.keywordInput || '');
                        setExistingKeywords(parsed.existingKeywords || '');
                        setProductDescription(parsed.productDescription || '');
                        setKeywordLanguage(parsed.keywordLanguage || 'multi');
                        setBrandList(parsed.brandList || '');
                        setCustomColumns(parsed.customColumns || []);
                        setTableData(parsed.tableData || [{ term: '', volume: '', custom: {} }]);
                        setShowSetup(false);
                        setShowRestoreDialog(false);
                        alert('Previous setup restored successfully!');
                    }
                } catch (error) {
                    console.error('Error loading state:', error);
                    alert('Error loading saved state. Starting fresh.');
                }
            };

            // Clear saved state
            const clearSavedState = () => {
                try {
                    localStorage.removeItem('ppcCampaignBuilder_savedState');
                    setShowRestoreDialog(false);
                } catch (error) {
                    console.error('Error clearing state:', error);
                }
            };

            // Check for saved state on mount
            useEffect(() => {
                const savedState = localStorage.getItem('ppcCampaignBuilder_savedState');
                if (savedState) {
                    setSavedStateExists(true);
                    setShowRestoreDialog(true);
                }
            }, []);

            // Auto-save when important state changes
            useEffect(() => {
                if (keywords.length > 0 || keywordInput || productDescription) {
                    const timeoutId = setTimeout(() => {
                        saveState();
                    }, 1000); // Debounce saves by 1 second
                    return () => clearTimeout(timeoutId);
                }
            }, [keywords, campaigns, keywordInput, existingKeywords, productDescription, keywordLanguage, brandList]);

            // Parse and load keywords
            const loadKeywords = () => {
                // Filter out completely empty rows (no term)
                const validTableRows = tableData.filter(row => row.term.trim());
                
                if (validTableRows.length === 0) {
                    alert('Please enter at least one keyword.');
                    return;
                }
                
                // Create existing keywords set with better normalization
                const existingSet = new Set(
                    existingKeywords.toLowerCase()
                        .split('\n')
                        .map(k => k.trim().replace(/\s+/g, ' ')) // Normalize spaces
                        .filter(Boolean)
                );

                const parsed = validTableRows
                    .map(row => {
                        const keyword = row.term.trim();
                        const volume = parseInt(row.volume) || 0; // Default to 0 if no volume

                        // Only return if we have a valid keyword
                        if (!keyword) return null;

                        // Normalize keyword for comparison
                        const normalizedKeyword = keyword.toLowerCase().trim().replace(/\s+/g, ' ');
                        const isExisting = existingSet.has(normalizedKeyword);
                        
                        return {
                            id: Math.random().toString(36).substr(2, 9),
                            keyword,
                            volume,
                            campaignId: null,
                            excluded: isExisting,
                            isExisting,
                            roots: extractRootsForKeyword(keyword),
                            customData: row.custom || {} // Store custom column data
                        };
                    })
                    .filter(Boolean);
                
                // REMOVE DUPLICATES - Keep the one with higher volume
                const deduped = [];
                const seenKeywords = new Map();
                let duplicatesCount = 0;
                
                parsed.forEach(kw => {
                    const keyLower = kw.keyword.toLowerCase().trim();
                    
                    if (seenKeywords.has(keyLower)) {
                        duplicatesCount++;
                        const existing = seenKeywords.get(keyLower);
                        if (kw.volume > existing.volume) {
                            // Replace with higher volume version
                            const index = deduped.findIndex(k => k.keyword.toLowerCase().trim() === keyLower);
                            if (index !== -1) {
                                deduped[index] = kw;
                                seenKeywords.set(keyLower, kw);
                            }
                        }
                    } else {
                        deduped.push(kw);
                        seenKeywords.set(keyLower, kw);
                    }
                });

                if (duplicatesCount > 0) {
                    alert(`Removed ${duplicatesCount} duplicate keyword(s), keeping highest volume versions.`);
                }

                if (mergeMode) {
                    // Keep existing campaigns & merge new keywords
                    const existingIds = new Set(keywords.map(k => k.keyword.toLowerCase()));
                    const newKeywords = deduped.filter(k => !existingIds.has(k.keyword.toLowerCase()));
                    setKeywords([...keywords, ...newKeywords]);
                } else {
                    // Replace mode
                    setKeywords(deduped);
                }
                
                setShowSetup(false);
                // Keep table data so user can go back and edit
            };

            // Extract root words from a keyword
            const extractRootsForKeyword = (keyword) => {
                const stopWords = new Set(['for', 'with', 'and', 'the', 'a', 'an', 'in', 'on', 'at', 'to', 'of', 'by']);
                const brandWords = new Set(brandList.toLowerCase().split('\n').map(b => b.trim()).filter(Boolean));
                
                return keyword.toLowerCase()
                    .split(/\s+/)
                    .filter(word => word.length >= 2 && !stopWords.has(word) && !brandWords.has(word));
            };

            // Get all unique roots with stats
            const allRoots = useMemo(() => {
                const rootMap = new Map();
                
                keywords.forEach(kw => {
                    // Only skip excluded keywords - include both assigned and unassigned
                    if (kw.excluded) return;
                    
                    kw.roots.forEach(root => {
                        if (!rootMap.has(root)) {
                            rootMap.set(root, { root, count: 0, volume: 0, keywords: [] });
                        }
                        const stats = rootMap.get(root);
                        stats.count++;
                        stats.volume += kw.volume;
                        stats.keywords.push(kw);
                    });
                });

                return Array.from(rootMap.values())
                    .sort((a, b) => b.volume - a.volume);
            }, [keywords]);

            // Close root dropdown when clicking outside
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (showRootDropdown && !event.target.closest('.relative')) {
                        setShowRootDropdown(false);
                    }
                };
                
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [showRootDropdown]);

            // Campaign management
            const addCampaign = () => {
                const newId = Math.max(...campaigns.map(c => c.id)) + 1;
                setCampaigns([...campaigns, {
                    id: newId,
                    name: `Campaign ${newId}`,
                    matchType: 'Exact',
                    maxKeywords: 30,
                    minVolume: 0,
                    maxVolume: 100000
                }]);
            };

            const removeCampaign = (id) => {
                if (campaigns.length === 1) {
                    alert('Cannot delete the last campaign!');
                    return;
                }
                
                // Unassign all keywords from this campaign
                setKeywords(keywords.map(kw => 
                    kw.campaignId === id ? { ...kw, campaignId: null } : kw
                ));
                
                setCampaigns(campaigns.filter(c => c.id !== id));
            };

            const updateCampaign = (id, field, value) => {
                setCampaigns(campaigns.map(c => 
                    c.id === id ? { ...c, [field]: value } : c
                ));
            };

            // Keyword assignment
            const assignKeyword = (keywordId, campaignId) => {
                setKeywords(keywords.map(kw => 
                    kw.id === keywordId ? { ...kw, campaignId } : kw
                ));
            };

            const toggleKeywordSelection = (keywordId) => {
                setSelectedKeywords(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(keywordId)) {
                        newSet.delete(keywordId);
                    } else {
                        newSet.add(keywordId);
                    }
                    return newSet;
                });
            };

            const bulkAssignSelected = (campaignId) => {
                if (selectedKeywords.size === 0) return;
                
                const campaign = campaigns.find(c => c.id === campaignId);
                if (!campaign) return;

                const currentCount = keywords.filter(k => k.campaignId === campaignId).length;
                const availableSlots = campaign.maxKeywords - currentCount;
                
                let assigned = 0;
                const updatedKeywords = keywords.map(kw => {
                    if (selectedKeywords.has(kw.id) && kw.campaignId === null && assigned < availableSlots) {
                        if (kw.volume >= campaign.minVolume && kw.volume <= campaign.maxVolume) {
                            assigned++;
                            return { ...kw, campaignId };
                        }
                    }
                    return kw;
                });

                setKeywords(updatedKeywords);
                setSelectedKeywords(new Set());
                
                if (assigned < selectedKeywords.size) {
                    alert(`Assigned ${assigned} keywords. ${selectedKeywords.size - assigned} couldn't be assigned due to limits.`);
                }
            };

            const bulkUnassignSelected = () => {
                if (selectedKeywords.size === 0) return;
                
                const updatedKeywords = keywords.map(kw => 
                    selectedKeywords.has(kw.id) ? { ...kw, campaignId: null } : kw
                );
                
                setKeywords(updatedKeywords);
                setSelectedKeywords(new Set());
            };

            const bulkExcludeSelected = () => {
                if (selectedKeywords.size === 0) return;
                
                const updatedKeywords = keywords.map(kw => 
                    selectedKeywords.has(kw.id) ? { ...kw, excluded: true, campaignId: null } : kw
                );
                
                setKeywords(updatedKeywords);
                // Remove excluded keywords from smartSuggestions
                setSmartSuggestions(smartSuggestions.filter(s => !selectedKeywords.has(s.keywordId)));
                setSelectedKeywords(new Set());
            };

            const bulkIncludeSelected = () => {
                if (selectedKeywords.size === 0) return;
                
                const updatedKeywords = keywords.map(kw => 
                    selectedKeywords.has(kw.id) ? { ...kw, excluded: false } : kw
                );
                
                setKeywords(updatedKeywords);
                setSelectedKeywords(new Set());
            };

            const reapplyExistingKeywords = () => {
                if (!existingKeywords.trim()) {
                    alert('Please enter existing keywords to exclude in the Setup first.');
                    return;
                }

                // Create existing keywords set with normalization
                const existingSet = new Set(
                    existingKeywords.toLowerCase()
                        .split('\n')
                        .map(k => k.trim().replace(/\s+/g, ' '))
                        .filter(Boolean)
                );

                let excludedCount = 0;
                const excludedIds = new Set();
                const updatedKeywords = keywords.map(kw => {
                    const normalizedKeyword = kw.keyword.toLowerCase().trim().replace(/\s+/g, ' ');
                    if (existingSet.has(normalizedKeyword) && !kw.excluded) {
                        excludedCount++;
                        excludedIds.add(kw.id);
                        return { ...kw, excluded: true, isExisting: true, campaignId: null };
                    }
                    return kw;
                });

                setKeywords(updatedKeywords);
                // Remove excluded keywords from smartSuggestions
                setSmartSuggestions(smartSuggestions.filter(s => !excludedIds.has(s.keywordId)));
                
                if (excludedCount > 0) {
                    alert(`Excluded ${excludedCount} existing keyword(s).`);
                } else {
                    alert('No matching keywords found to exclude.');
                }
            };

            const bulkAssignByRoot = (root, campaignId) => {
                const campaign = campaigns.find(c => c.id === campaignId);
                if (!campaign) return;

                const currentCount = keywords.filter(k => k.campaignId === campaignId).length;
                const availableSlots = campaign.maxKeywords - currentCount;

                const rootKeywords = keywords
                    .filter(kw => kw.roots.includes(root) && kw.campaignId === null && !kw.excluded)
                    .filter(kw => kw.volume >= campaign.minVolume && kw.volume <= campaign.maxVolume)
                    .sort((a, b) => b.volume - a.volume)
                    .slice(0, availableSlots);

                const assignedIds = new Set(rootKeywords.map(k => k.id));
                
                setKeywords(keywords.map(kw => 
                    assignedIds.has(kw.id) ? { ...kw, campaignId } : kw
                ));

                setLastBulkAssign({ root, campaign: campaign.name, count: rootKeywords.length });
            };

            const splitRoot = (root, numSplits) => {
                const rootKeywords = keywords
                    .filter(kw => kw.roots.includes(root) && kw.campaignId === null && !kw.excluded)
                    .sort((a, b) => b.volume - a.volume);

                if (rootKeywords.length < numSplits) {
                    alert('Not enough keywords to split into that many groups!');
                    return;
                }

                const perGroup = Math.ceil(rootKeywords.length / numSplits);
                const newCampaigns = [];
                const maxId = Math.max(...campaigns.map(c => c.id));

                for (let i = 0; i < numSplits; i++) {
                    const newId = maxId + i + 1;
                    newCampaigns.push({
                        id: newId,
                        name: `${root} ${i + 1}`,
                        matchType: 'Exact',
                        maxKeywords: perGroup + 5,
                        minVolume: 0,
                        maxVolume: 100000
                    });
                }

                setCampaigns([...campaigns, ...newCampaigns]);

                const updatedKeywords = [...keywords];
                for (let i = 0; i < numSplits; i++) {
                    const start = i * perGroup;
                    const end = Math.min((i + 1) * perGroup, rootKeywords.length);
                    const groupKeywords = rootKeywords.slice(start, end);
                    
                    groupKeywords.forEach(kw => {
                        const idx = updatedKeywords.findIndex(k => k.id === kw.id);
                        if (idx !== -1) {
                            updatedKeywords[idx] = { ...updatedKeywords[idx], campaignId: newCampaigns[i].id };
                        }
                    });
                }

                setKeywords(updatedKeywords);
            };

            const excludeKeyword = (keywordId) => {
                const targetKeyword = keywords.find(kw => kw.id === keywordId);
                const willBeExcluded = targetKeyword && !targetKeyword.excluded;
                
                setKeywords(keywords.map(kw => 
                    kw.id === keywordId ? { ...kw, excluded: !kw.excluded, campaignId: null } : kw
                ));
                
                // If excluding the keyword, remove it from smartSuggestions
                if (willBeExcluded) {
                    setSmartSuggestions(smartSuggestions.filter(s => s.keywordId !== keywordId));
                }
            };

            // Smart suggestions - identifies irrelevant keywords to exclude
            const generateSuggestions = async () => {
                if (!productDescription.trim()) {
                    alert('Please enter a product description first!');
                    return;
                }

                // Get unassigned, non-excluded keywords
                const keywordsToAnalyze = keywords.filter(kw => !kw.excluded && kw.campaignId === null);
                
                if (keywordsToAnalyze.length === 0) {
                    alert('No keywords to analyze! All are either excluded or already assigned.');
                    return;
                }

                // Show loading message
                const originalButton = document.querySelector('[onClick*="generateSuggestions"]');
                if (originalButton) {
                    originalButton.disabled = true;
                    originalButton.textContent = 'â³ AI Analyzing...';
                }

                try {
                    // Build language-specific context
                    const languageContexts = {
                        german: {
                            intro: "You are a German-speaking PPC advertising expert. Analyze these GERMAN keywords.",
                            note: "IMPORTANT: All keywords are in GERMAN. Understand German compound words (e.g., 'badewannenmatte' = bathtub mat) and semantic relationships.",
                            examples: "Example: 'duschmatte' (shower mat) vs 'yogamatte' (yoga mat) - both are mats but VERY different products"
                        },
                        english: {
                            intro: "You are a PPC advertising expert. Analyze these ENGLISH keywords.",
                            note: "IMPORTANT: All keywords are in ENGLISH.",
                            examples: "Example: 'bath mat' vs 'yoga mat' - both are mats but VERY different products"
                        },
                        french: {
                            intro: "You are a French-speaking PPC advertising expert. Analyze these FRENCH keywords.",
                            note: "IMPORTANT: All keywords are in FRENCH. Understand French word meanings and semantic relationships.",
                            examples: "Example: 'tapis de bain' (bath mat) vs 'tapis de yoga' (yoga mat) - both are mats but VERY different products"
                        },
                        spanish: {
                            intro: "You are a Spanish-speaking PPC advertising expert. Analyze these SPANISH keywords.",
                            note: "IMPORTANT: All keywords are in SPANISH. Understand Spanish word meanings and semantic relationships.",
                            examples: "Example: 'alfombra de baÃ±o' (bath mat) vs 'alfombra de yoga' (yoga mat) - both are mats but VERY different products"
                        },
                        italian: {
                            intro: "You are an Italian-speaking PPC advertising expert. Analyze these ITALIAN keywords.",
                            note: "IMPORTANT: All keywords are in ITALIAN. Understand Italian word meanings and semantic relationships.",
                            examples: "Example: 'tappetino da bagno' (bath mat) vs 'tappetino yoga' (yoga mat) - both are mats but VERY different products"
                        },
                        dutch: {
                            intro: "You are a Dutch-speaking PPC advertising expert. Analyze these DUTCH keywords.",
                            note: "IMPORTANT: All keywords are in DUTCH. Understand Dutch compound words and semantic relationships.",
                            examples: "Example: 'badmat' (bath mat) vs 'yogamat' (yoga mat) - both are mats but VERY different products"
                        },
                        polish: {
                            intro: "You are a Polish-speaking PPC advertising expert. Analyze these POLISH keywords.",
                            note: "IMPORTANT: All keywords are in POLISH. Understand Polish word meanings and semantic relationships.",
                            examples: "Example: 'mata Å‚azienkowa' (bath mat) vs 'mata do jogi' (yoga mat) - both are mats but VERY different products"
                        },
                        multi: {
                            intro: "You are a multilingual PPC advertising expert. Analyze these keywords which may be in MULTIPLE LANGUAGES.",
                            note: "IMPORTANT: Keywords may be in different languages (German, English, French, Spanish, Italian, etc.). Detect the language of each keyword and understand its meaning in that language.",
                            examples: "Example: 'badematte' (German bath mat) vs 'yoga mat' (English) - both are mats but VERY different products"
                        }
                    };
                    
                    const context = languageContexts[keywordLanguage] || languageContexts.multi;
                    
                    // Build prompt for AI
                    const prompt = `${context.intro}

${context.note}

Product Description: ${productDescription}

Keywords to analyze (with search volume):
${keywordsToAnalyze.map((kw, i) => `${i}. ${kw.keyword} (${kw.volume.toLocaleString()} volume)`).join('\n')}

Task: Identify keywords that are NOT relevant to this product.

RED FLAGS - Mark as irrelevant if keyword is:
1. **Different product entirely**: 
   - ${context.examples}
   - Focus on PRODUCT INTENT, not just shared words
   
2. **Wrong room/location/use case**:
   - Example: If product is for bathroom, exclude kitchen/car/office items
   
3. **Wrong category/purpose**:
   - Example: Decorative items when selling functional items
   - Example: Different sports/activities
   
4. **Different material/type**:
   - Example: Rubber vs textile, slip-resistant vs decorative
   
5. **Brand names** (VERY IMPORTANT):
   - Competitor brand names (e.g., specific manufacturer names)
   - Any recognizable brand/company names in the keyword
   - Product names with brand identifiers
   - Example: "nike bath mat", "adidas shower mat", "ikea bathroom mat"
   - Look for capitalized words or known brand patterns

ANALYSIS INSTRUCTIONS:
- Understand word meanings in the keyword's language
- Consider semantic meaning and INTENT, not just word matching
- A keyword with 1-2 matching words is NOT enough - the overall INTENT must match
- High search volume does NOT mean relevant!
- Be thorough but fair
- Pay special attention to potential brand names in keywords

Return ONLY a valid JSON array of indices for IRRELEVANT keywords.
Example format: [0, 5, 12, 23]

Be thorough - flag anything that doesn't clearly match the product intent.`;


                    // Call local proxy server (which handles CORS)
                    const response = await fetch('http://localhost:8080/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'claude-3-haiku-20240307',
                            max_tokens: 2048,
                            messages: [{
                                role: 'user',
                                content: prompt
                            }]
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    const responseText = data.content[0].text;
                    
                    // Parse JSON response
                    const irrelevantIndices = JSON.parse(responseText.match(/\[[\d\s,]+\]/)[0]);
                    
                    // Build suggestions
                    const suggestions = irrelevantIndices.map(index => {
                        const kw = keywordsToAnalyze[index];
                        return {
                            keyword: kw.keyword,
                            keywordId: kw.id,
                            reason: 'AI suggests this is not relevant to your product',
                            confidence: 0.9,
                            volume: kw.volume
                        };
                    });

                    // Sort by volume
                    suggestions.sort((a, b) => b.volume - a.volume);

                    // Show results
                    if (suggestions.length === 0) {
                        alert(`âœ… Great! AI analyzed ${keywordsToAnalyze.length} keywords and found them all relevant!`);
                        setSmartSuggestions([]);
                    } else {
                        alert(`ðŸ¤– AI analyzed ${keywordsToAnalyze.length} keywords and found ${suggestions.length} potentially irrelevant ones!`);
                        setSmartSuggestions(suggestions);
                        setShowSuggestions(true);
                    }

                } catch (error) {
                    console.error('AI Analysis Error:', error);
                    alert(`âŒ Error analyzing keywords: ${error.message}\n\nCheck browser console (F12) for details.`);
                    setSmartSuggestions([]);
                } finally {
                    // Reset button
                    if (originalButton) {
                        originalButton.disabled = false;
                        originalButton.textContent = 'ðŸ” Find Irrelevant Keywords';
                    }
                }
            };

            const excludeSuggestion = (suggestion) => {
                // Exclude the keyword
                setKeywords(keywords.map(kw => 
                    kw.id === suggestion.keywordId ? { ...kw, excluded: true, campaignId: null } : kw
                ));
                // Remove from suggestions
                setSmartSuggestions(smartSuggestions.filter(s => s.keywordId !== suggestion.keywordId));
            };

            const keepSuggestion = (suggestion) => {
                // Just remove from suggestions, don't change keyword
                setSmartSuggestions(smartSuggestions.filter(s => s.keywordId !== suggestion.keywordId));
            };

            // Auto-assign functions
            const openAutoAssign = () => {
                setAutoAssignConfig({
                    selectedRoots: new Set(),
                    rootConfigs: {},
                    rootGroups: [],
                    globalMaxKeywords: '',
                    globalMinVolume: '',
                    globalMaxVolume: ''
                });
                setAutoAssignRootSearch('');
                setShowAutoAssign(true);
            };

            const toggleRootSelection = (root) => {
                // Check if root is already in a group
                const inGroup = autoAssignConfig.rootGroups.find(g => g.roots.has(root));
                if (inGroup) {
                    alert(`"${root}" is already in the group "${inGroup.name}". Remove it from the group first if you want to configure it separately.`);
                    return;
                }
                
                const newSelected = new Set(autoAssignConfig.selectedRoots);
                if (newSelected.has(root)) {
                    newSelected.delete(root);
                    const newConfigs = { ...autoAssignConfig.rootConfigs };
                    delete newConfigs[root];
                    setAutoAssignConfig({
                        ...autoAssignConfig,
                        selectedRoots: newSelected,
                        rootConfigs: newConfigs
                    });
                } else {
                    newSelected.add(root);
                    setAutoAssignConfig({
                        ...autoAssignConfig,
                        selectedRoots: newSelected,
                        rootConfigs: {
                            ...autoAssignConfig.rootConfigs,
                            [root]: {
                                numCampaigns: 2,
                                campaigns: [
                                    { name: `${root} High`, percentage: 70 },
                                    { name: `${root} Low`, percentage: 30 }
                                ]
                            }
                        }
                    });
                }
            };

            const updateRootConfig = (root, field, value) => {
                if (field === 'numCampaigns') {
                    const num = parseInt(value) || 2;
                    const existingCampaigns = autoAssignConfig.rootConfigs[root].campaigns;
                    const newCampaigns = [];
                    
                    for (let i = 0; i < num; i++) {
                        if (i < existingCampaigns.length) {
                            newCampaigns.push(existingCampaigns[i]);
                        } else {
                            newCampaigns.push({
                                name: `${root} ${i + 1}`,
                                percentage: Math.floor(100 / num)
                            });
                        }
                    }
                    
                    // Adjust percentages to sum to 100
                    const total = newCampaigns.reduce((sum, c) => sum + c.percentage, 0);
                    if (total !== 100 && newCampaigns.length > 0) {
                        newCampaigns[0].percentage += (100 - total);
                    }
                    
                    setAutoAssignConfig({
                        ...autoAssignConfig,
                        rootConfigs: {
                            ...autoAssignConfig.rootConfigs,
                            [root]: {
                                ...autoAssignConfig.rootConfigs[root],
                                numCampaigns: num,
                                campaigns: newCampaigns
                            }
                        }
                    });
                }
            };

            const updateCampaignConfig = (root, campaignIndex, field, value) => {
                const newCampaigns = [...autoAssignConfig.rootConfigs[root].campaigns];
                newCampaigns[campaignIndex] = {
                    ...newCampaigns[campaignIndex],
                    [field]: field === 'percentage' ? (parseInt(value) || 0) : value
                };
                
                setAutoAssignConfig({
                    ...autoAssignConfig,
                    rootConfigs: {
                        ...autoAssignConfig.rootConfigs,
                        [root]: {
                            ...autoAssignConfig.rootConfigs[root],
                            campaigns: newCampaigns
                        }
                    }
                });
            };

            const executeAutoAssign = () => {
                if (autoAssignConfig.selectedRoots.size === 0 && autoAssignConfig.rootGroups.length === 0) {
                    alert('Please select at least one root or create a root group!');
                    return;
                }

                const newCampaigns = [];
                const updatedKeywords = [...keywords];
                let maxCampaignId = Math.max(...campaigns.map(c => c.id));

                // Collect all roots that are part of any group
                const rootsInGroups = new Set();
                autoAssignConfig.rootGroups.forEach(group => {
                    group.roots.forEach(root => rootsInGroups.add(root));
                });

                // Process individual roots (skip those that are in groups)
                autoAssignConfig.selectedRoots.forEach(root => {
                    // Skip this root if it's part of any combined group
                    if (rootsInGroups.has(root)) return;
                    
                    const config = autoAssignConfig.rootConfigs[root];
                    const rootData = allRoots.find(r => r.root === root);
                    
                    if (!rootData || !config) return;

                    // Get all unassigned keywords for this root
                    let availableKeywords = keywords
                        .filter(kw => kw.roots.includes(root) && kw.campaignId === null && !kw.excluded)
                        .sort((a, b) => b.volume - a.volume); // Sort by volume descending

                    // Apply global filters if set
                    if (autoAssignConfig.globalMinVolume) {
                        availableKeywords = availableKeywords.filter(kw => 
                            kw.volume >= parseInt(autoAssignConfig.globalMinVolume)
                        );
                    }
                    if (autoAssignConfig.globalMaxVolume) {
                        availableKeywords = availableKeywords.filter(kw => 
                            kw.volume <= parseInt(autoAssignConfig.globalMaxVolume)
                        );
                    }

                    const totalVolume = availableKeywords.reduce((sum, kw) => sum + kw.volume, 0);

                    // Create campaigns and assign keywords
                    config.campaigns.forEach((campaignConfig, index) => {
                        maxCampaignId++;
                        
                        const maxKeywords = autoAssignConfig.globalMaxKeywords 
                            ? parseInt(autoAssignConfig.globalMaxKeywords) 
                            : 100;

                        const newCampaign = {
                            id: maxCampaignId,
                            name: campaignConfig.name,
                            matchType: 'Exact',
                            maxKeywords: maxKeywords,
                            minVolume: 0,
                            maxVolume: 999999
                        };
                        newCampaigns.push(newCampaign);

                        // Calculate target volume for this campaign
                        const targetVolume = totalVolume * (campaignConfig.percentage / 100);
                        let currentVolume = 0;
                        let assignedCount = 0;

                        // Assign keywords until we reach the target volume or limits
                        for (let i = 0; i < availableKeywords.length; i++) {
                            const kw = availableKeywords[i];
                            
                            // Check if already assigned
                            const kwIndex = updatedKeywords.findIndex(k => k.id === kw.id);
                            if (kwIndex === -1 || updatedKeywords[kwIndex].campaignId !== null) {
                                continue;
                            }

                            // Check if we've reached target volume (with some tolerance)
                            if (currentVolume >= targetVolume && index < config.campaigns.length - 1) {
                                break;
                            }

                            // Check max keywords limit
                            if (autoAssignConfig.globalMaxKeywords && assignedCount >= maxKeywords) {
                                break;
                            }

                            // Assign keyword
                            updatedKeywords[kwIndex] = {
                                ...updatedKeywords[kwIndex],
                                campaignId: newCampaign.id
                            };
                            currentVolume += kw.volume;
                            assignedCount++;
                        }
                    });
                });

                // Process root groups
                autoAssignConfig.rootGroups.forEach(group => {
                    // Get all unassigned keywords that contain ANY of the roots in this group
                    let availableKeywords = keywords
                        .filter(kw => 
                            !kw.excluded && 
                            kw.campaignId === null &&
                            kw.roots.some(root => group.roots.has(root))
                        )
                        .sort((a, b) => b.volume - a.volume);

                    // Apply global filters if set
                    if (autoAssignConfig.globalMinVolume) {
                        availableKeywords = availableKeywords.filter(kw => 
                            kw.volume >= parseInt(autoAssignConfig.globalMinVolume)
                        );
                    }
                    if (autoAssignConfig.globalMaxVolume) {
                        availableKeywords = availableKeywords.filter(kw => 
                            kw.volume <= parseInt(autoAssignConfig.globalMaxVolume)
                        );
                    }

                    const totalVolume = availableKeywords.reduce((sum, kw) => sum + kw.volume, 0);

                    // Create campaigns and assign keywords for this group
                    group.campaigns.forEach((campaignConfig, index) => {
                        maxCampaignId++;
                        
                        const maxKeywords = autoAssignConfig.globalMaxKeywords 
                            ? parseInt(autoAssignConfig.globalMaxKeywords) 
                            : 100;

                        const newCampaign = {
                            id: maxCampaignId,
                            name: campaignConfig.name,
                            matchType: 'Exact',
                            maxKeywords: maxKeywords,
                            minVolume: 0,
                            maxVolume: 999999
                        };
                        newCampaigns.push(newCampaign);

                        // Calculate target volume for this campaign
                        const targetVolume = totalVolume * (parseFloat(campaignConfig.percentage) / 100);
                        let currentVolume = 0;
                        let assignedCount = 0;

                        // Assign keywords until we reach the target volume or limits
                        for (let i = 0; i < availableKeywords.length; i++) {
                            const kw = availableKeywords[i];
                            
                            // Check if already assigned
                            const kwIndex = updatedKeywords.findIndex(k => k.id === kw.id);
                            if (kwIndex === -1 || updatedKeywords[kwIndex].campaignId !== null) {
                                continue;
                            }

                            // Check if we've reached target volume
                            if (currentVolume >= targetVolume && index < group.campaigns.length - 1) {
                                break;
                            }

                            // Check max keywords limit
                            if (autoAssignConfig.globalMaxKeywords && assignedCount >= maxKeywords) {
                                break;
                            }

                            // Assign keyword
                            updatedKeywords[kwIndex] = {
                                ...updatedKeywords[kwIndex],
                                campaignId: newCampaign.id
                            };
                            currentVolume += kw.volume;
                            assignedCount++;
                        }
                    });
                });

                // Update state
                setCampaigns([...campaigns, ...newCampaigns]);
                setKeywords(updatedKeywords);
                setShowAutoAssign(false);

                alert(`Successfully created ${newCampaigns.length} campaigns and assigned keywords!`);
            };

            // Filtering and sorting
            const filteredKeywords = useMemo(() => {
                let filtered = keywords;

                // Assignment status filter
                if (assignmentFilter === 'assigned') {
                    filtered = filtered.filter(kw => kw.campaignId !== null);
                } else if (assignmentFilter === 'unassigned') {
                    filtered = filtered.filter(kw => kw.campaignId === null && !kw.excluded);
                } else if (assignmentFilter === 'excluded') {
                    filtered = filtered.filter(kw => kw.excluded);
                } else if (assignmentFilter === 'included') {
                    filtered = filtered.filter(kw => !kw.excluded);
                }

                // Root filter - now supports multiple selections
                if (!rootFilter.has('all')) {
                    filtered = filtered.filter(kw => 
                        kw.roots.some(root => rootFilter.has(root))
                    );
                }

                // Campaign filter
                if (campaignFilter !== 'all') {
                    const campaignId = parseInt(campaignFilter);
                    filtered = filtered.filter(kw => kw.campaignId === campaignId);
                }

                // Search filter
                if (searchFilter) {
                    const search = searchFilter.toLowerCase();
                    filtered = filtered.filter(kw => kw.keyword.toLowerCase().includes(search));
                }

                // Volume filters
                if (volumeMin) {
                    filtered = filtered.filter(kw => kw.volume >= parseInt(volumeMin));
                }
                if (volumeMax) {
                    filtered = filtered.filter(kw => kw.volume <= parseInt(volumeMax));
                }

                // Root count filters - FIXED: Now filters by root FREQUENCY (how many keywords contain this root)
                if (rootCountMin) {
                    filtered = filtered.filter(kw => {
                        return kw.roots.some(root => {
                            const rootData = allRoots.find(r => r.root === root);
                            return rootData && rootData.count >= parseInt(rootCountMin);
                        });
                    });
                }
                if (rootCountMax) {
                    filtered = filtered.filter(kw => {
                        return kw.roots.some(root => {
                            const rootData = allRoots.find(r => r.root === root);
                            return rootData && rootData.count <= parseInt(rootCountMax);
                        });
                    });
                }

                // Sorting
                switch (sortBy) {
                    case 'volume-desc':
                        filtered.sort((a, b) => b.volume - a.volume);
                        break;
                    case 'volume-asc':
                        filtered.sort((a, b) => a.volume - b.volume);
                        break;
                    case 'alpha-asc':
                        filtered.sort((a, b) => a.keyword.localeCompare(b.keyword));
                        break;
                    case 'alpha-desc':
                        filtered.sort((a, b) => b.keyword.localeCompare(a.keyword));
                        break;
                    case 'roots-desc':
                        filtered.sort((a, b) => b.roots.length - a.roots.length);
                        break;
                    case 'roots-asc':
                        filtered.sort((a, b) => a.roots.length - b.roots.length);
                        break;
                }

                return filtered;
            }, [keywords, rootFilter, searchFilter, sortBy, volumeMin, volumeMax, rootCountMin, rootCountMax, assignmentFilter, campaignFilter, allRoots]);

            // Export
            const exportData = () => {
                // CSV Header
                let csvContent = 'Campaign,Match Type,Keyword,Volume\n';
                
                // Add each keyword with its campaign info
                campaigns.forEach(campaign => {
                    const campaignKeywords = keywords.filter(k => k.campaignId === campaign.id);
                    campaignKeywords.forEach(kw => {
                        // Escape quotes in keyword and wrap in quotes if contains comma
                        const keyword = kw.keyword.includes(',') || kw.keyword.includes('"') 
                            ? `"${kw.keyword.replace(/"/g, '""')}"` 
                            : kw.keyword;
                        const campaignName = campaign.name.includes(',') || campaign.name.includes('"')
                            ? `"${campaign.name.replace(/"/g, '""')}"`
                            : campaign.name;
                        
                        csvContent += `${campaignName},${campaign.matchType},${keyword},${kw.volume}\n`;
                    });
                });

                // Create and download CSV
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ppc-campaigns.csv';
                a.click();
                URL.revokeObjectURL(url);
            };

            // Stats
            const stats = useMemo(() => {
                const unassigned = keywords.filter(k => k.campaignId === null && !k.excluded).length;
                const assigned = keywords.filter(k => k.campaignId !== null).length;
                const excluded = keywords.filter(k => k.excluded).length;
                const totalVolume = keywords.reduce((sum, k) => sum + k.volume, 0);

                return { unassigned, assigned, excluded, totalVolume, total: keywords.length };
            }, [keywords]);

            const campaignStats = useMemo(() => {
                return campaigns.map(campaign => {
                    const campaignKeywords = keywords.filter(k => k.campaignId === campaign.id);
                    return {
                        id: campaign.id,
                        count: campaignKeywords.length,
                        volume: campaignKeywords.reduce((sum, k) => sum + k.volume, 0)
                    };
                });
            }, [keywords, campaigns]);

            if (showSetup) {
                return (
                    <div className="min-h-screen gradient-bg flex items-center justify-center p-6">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-4xl w-full">
                            <h1 className="text-4xl font-bold text-gray-800 mb-2 text-center">
                                ðŸŽ¯ Amazon PPC Campaign Builder V7
                            </h1>
                            <p className="text-gray-600 mb-8 text-center">Auto-Assign by Search Volume Edition</p>

                            <div className="space-y-6">
                                <div>
                                    <div className="flex justify-between items-center mb-2">
                                        <label className="block text-sm font-semibold text-gray-700">
                                            ðŸ“ Keywords Table
                                        </label>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={() => {
                                                    setTableData([...tableData, { term: '', volume: '', custom: {} }]);
                                                }}
                                                className="px-3 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600"
                                            >
                                                + Add Row
                                            </button>
                                            {selectedRows.size > 0 && (
                                                <button
                                                    onClick={() => {
                                                        const newData = tableData.filter((_, idx) => !selectedRows.has(idx));
                                                        setTableData(newData.length > 0 ? newData : [{ term: '', volume: '', custom: {} }]);
                                                        setSelectedRows(new Set());
                                                    }}
                                                    className="px-3 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600"
                                                >
                                                    Delete Selected ({selectedRows.size})
                                                </button>
                                            )}
                                            <button
                                                onClick={() => {
                                                    if (confirm('Clear all rows?')) {
                                                        setTableData([{ term: '', volume: '', custom: {} }]);
                                                        setSelectedRows(new Set());
                                                    }
                                                }}
                                                className="px-3 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600"
                                            >
                                                Clear All
                                            </button>
                                            <button
                                                onClick={() => setShowColumnManager(!showColumnManager)}
                                                className="px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600"
                                            >
                                                {showColumnManager ? 'Hide Columns' : 'Manage Columns'}
                                            </button>
                                        </div>
                                    </div>

                                    {showColumnManager && (
                                        <div className="mb-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                            <div className="flex gap-2 mb-2">
                                                <input
                                                    type="text"
                                                    value={newColumnName}
                                                    onChange={(e) => setNewColumnName(e.target.value)}
                                                    placeholder="Column name (e.g., Translation, Notes)"
                                                    className="flex-1 px-3 py-1 text-sm border border-gray-300 rounded"
                                                    onKeyPress={(e) => {
                                                        if (e.key === 'Enter' && newColumnName.trim()) {
                                                            setCustomColumns([...customColumns, newColumnName.trim()]);
                                                            setNewColumnName('');
                                                        }
                                                    }}
                                                />
                                                <button
                                                    onClick={() => {
                                                        if (newColumnName.trim()) {
                                                            setCustomColumns([...customColumns, newColumnName.trim()]);
                                                            setNewColumnName('');
                                                        }
                                                    }}
                                                    className="px-3 py-1 text-sm bg-purple-500 text-white rounded hover:bg-purple-600"
                                                >
                                                    Add Column
                                                </button>
                                            </div>
                                            {customColumns.length > 0 && (
                                                <div className="flex flex-wrap gap-2">
                                                    {customColumns.map((col, idx) => (
                                                        <span key={idx} className="inline-flex items-center gap-1 px-2 py-1 bg-white border border-gray-300 rounded text-xs">
                                                            {col}
                                                            <button
                                                                onClick={() => {
                                                                    setCustomColumns(customColumns.filter((_, i) => i !== idx));
                                                                }}
                                                                className="text-red-500 hover:text-red-700 ml-1"
                                                            >
                                                                Ã—
                                                            </button>
                                                        </span>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    <div className="mb-2 p-2 bg-green-50 rounded border border-green-200">
                                        <p className="text-xs text-green-800">
                                            ðŸ’¡ <strong>Tips:</strong>
                                            <br/>
                                            â€¢ Use checkboxes to select multiple rows, then click "Delete Selected"
                                            <br/>
                                            â€¢ Paste multiple lines into ANY field to auto-fill down the rows
                                            <br/>
                                            â€¢ Search Terms â†’ creates new rows
                                            <br/>
                                            â€¢ Volume or custom columns â†’ fills existing rows from that point down
                                        </p>
                                    </div>

                                    <div className="border-2 border-gray-300 rounded-lg overflow-hidden">
                                        <div className="overflow-x-auto max-h-96">
                                            <table className="w-full text-sm">
                                                <thead className="bg-gray-100 sticky top-0">
                                                    <tr>
                                                        <th className="px-3 py-2 text-center font-semibold border-b border-r border-gray-300 w-8">
                                                            <input
                                                                type="checkbox"
                                                                checked={selectedRows.size === tableData.length && tableData.length > 0}
                                                                onChange={(e) => {
                                                                    if (e.target.checked) {
                                                                        setSelectedRows(new Set(tableData.map((_, idx) => idx)));
                                                                    } else {
                                                                        setSelectedRows(new Set());
                                                                    }
                                                                }}
                                                            />
                                                        </th>
                                                        <th className="px-3 py-2 text-left font-semibold border-b border-r border-gray-300 w-8">#</th>
                                                        <th className="px-3 py-2 text-left font-semibold border-b border-r border-gray-300">Search Term</th>
                                                        <th className="px-3 py-2 text-left font-semibold border-b border-r border-gray-300 w-32">Volume</th>
                                                        {customColumns.map((col, idx) => (
                                                            <th key={idx} className="px-3 py-2 text-left font-semibold border-b border-r border-gray-300">
                                                                {col}
                                                            </th>
                                                        ))}
                                                        <th className="px-3 py-2 text-center font-semibold border-b border-gray-300 w-16">Del</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {tableData.map((row, rowIdx) => (
                                                        <tr key={rowIdx} className="hover:bg-gray-50">
                                                            <td className="px-3 py-2 border-b border-r border-gray-200 text-center">
                                                                <input
                                                                    type="checkbox"
                                                                    checked={selectedRows.has(rowIdx)}
                                                                    onChange={(e) => {
                                                                        const newSelected = new Set(selectedRows);
                                                                        if (e.target.checked) {
                                                                            newSelected.add(rowIdx);
                                                                        } else {
                                                                            newSelected.delete(rowIdx);
                                                                        }
                                                                        setSelectedRows(newSelected);
                                                                    }}
                                                                />
                                                            </td>
                                                            <td className="px-3 py-2 border-b border-r border-gray-200 text-gray-500">
                                                                {rowIdx + 1}
                                                            </td>
                                                            <td className="px-3 py-2 border-b border-r border-gray-200">
                                                                <input
                                                                    type="text"
                                                                    value={row.term}
                                                                    onChange={(e) => {
                                                                        const newData = [...tableData];
                                                                        newData[rowIdx].term = e.target.value;
                                                                        setTableData(newData);
                                                                    }}
                                                                    onPaste={(e) => {
                                                                        const pastedText = e.clipboardData.getData('text');
                                                                        const lines = pastedText.split('\n').filter(line => line.trim());
                                                                        
                                                                        if (lines.length > 1) {
                                                                            e.preventDefault();
                                                                            
                                                                            const newRows = [];
                                                                            lines.forEach(line => {
                                                                                line = line.trim();
                                                                                if (!line) return;
                                                                                
                                                                                let term = '';
                                                                                let volume = '';
                                                                                
                                                                                // Try to parse if it has volume
                                                                                if (line.includes('\t')) {
                                                                                    const parts = line.split('\t').filter(p => p.trim());
                                                                                    term = parts[0] || '';
                                                                                    volume = parts[1] || '';
                                                                                } else if (line.includes(',')) {
                                                                                    const parts = line.split(',').filter(p => p.trim());
                                                                                    term = parts[0] || '';
                                                                                    volume = parts[1] || '';
                                                                                } else {
                                                                                    const parts = line.split(/\s+/);
                                                                                    const lastPart = parts[parts.length - 1];
                                                                                    
                                                                                    if (!isNaN(lastPart) && lastPart.match(/^\d+$/)) {
                                                                                        volume = lastPart;
                                                                                        term = parts.slice(0, -1).join(' ');
                                                                                    } else {
                                                                                        term = line;
                                                                                        volume = '';
                                                                                    }
                                                                                }
                                                                                
                                                                                newRows.push({ term: term.trim(), volume: volume.trim(), custom: {} });
                                                                            });
                                                                            
                                                                            // Replace from current row onwards
                                                                            const newData = [...tableData];
                                                                            newData.splice(rowIdx, 1, ...newRows);
                                                                            setTableData(newData);
                                                                            setSelectedRows(new Set());
                                                                        }
                                                                    }}
                                                                    placeholder="Enter search term (or paste multiple)"
                                                                    className="w-full px-2 py-1 border border-gray-200 rounded focus:border-purple-500 focus:outline-none"
                                                                />
                                                            </td>
                                                            <td className="px-3 py-2 border-b border-r border-gray-200">
                                                                <input
                                                                    type="text"
                                                                    value={row.volume}
                                                                    onChange={(e) => {
                                                                        const newData = [...tableData];
                                                                        newData[rowIdx].volume = e.target.value;
                                                                        setTableData(newData);
                                                                    }}
                                                                    onPaste={(e) => {
                                                                        const pastedText = e.clipboardData.getData('text');
                                                                        const lines = pastedText.split('\n').map(l => l.trim()).filter(l => l);
                                                                        
                                                                        if (lines.length > 1) {
                                                                            e.preventDefault();
                                                                            const newData = [...tableData];
                                                                            
                                                                            // Fill volumes starting from current row
                                                                            lines.forEach((line, i) => {
                                                                                const targetIdx = rowIdx + i;
                                                                                if (targetIdx < newData.length) {
                                                                                    newData[targetIdx].volume = line;
                                                                                }
                                                                            });
                                                                            
                                                                            setTableData(newData);
                                                                        }
                                                                    }}
                                                                    placeholder="0"
                                                                    className="w-full px-2 py-1 border border-gray-200 rounded focus:border-purple-500 focus:outline-none text-center"
                                                                />
                                                            </td>
                                                            {customColumns.map((col, colIdx) => (
                                                                <td key={colIdx} className="px-3 py-2 border-b border-r border-gray-200">
                                                                    <input
                                                                        type="text"
                                                                        value={row.custom[col] || ''}
                                                                        onChange={(e) => {
                                                                            const newData = [...tableData];
                                                                            if (!newData[rowIdx].custom) newData[rowIdx].custom = {};
                                                                            newData[rowIdx].custom[col] = e.target.value;
                                                                            setTableData(newData);
                                                                        }}
                                                                        onPaste={(e) => {
                                                                            const pastedText = e.clipboardData.getData('text');
                                                                            const lines = pastedText.split('\n').map(l => l.trim()).filter(l => l);
                                                                            
                                                                            if (lines.length > 1) {
                                                                                e.preventDefault();
                                                                                const newData = [...tableData];
                                                                                
                                                                                // Fill custom column data starting from current row
                                                                                lines.forEach((line, i) => {
                                                                                    const targetIdx = rowIdx + i;
                                                                                    if (targetIdx < newData.length) {
                                                                                        if (!newData[targetIdx].custom) newData[targetIdx].custom = {};
                                                                                        newData[targetIdx].custom[col] = line;
                                                                                    }
                                                                                });
                                                                                
                                                                                setTableData(newData);
                                                                            }
                                                                        }}
                                                                        placeholder="..."
                                                                        className="w-full px-2 py-1 border border-gray-200 rounded focus:border-purple-500 focus:outline-none"
                                                                    />
                                                                </td>
                                                            ))}
                                                            <td className="px-3 py-2 border-b border-gray-200 text-center">
                                                                <button
                                                                    onClick={() => {
                                                                        if (tableData.length > 1) {
                                                                            setTableData(tableData.filter((_, i) => i !== rowIdx));
                                                                        }
                                                                    }}
                                                                    className="text-red-500 hover:text-red-700 font-bold"
                                                                >
                                                                    Ã—
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    
                                    <div className="mt-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                        <p className="text-xs text-blue-800 font-semibold mb-2">ðŸ’¡ Quick Import from Text:</p>
                                        <textarea
                                            value={keywordInput}
                                            onChange={(e) => setKeywordInput(e.target.value)}
                                            className="w-full h-24 p-2 border border-blue-300 rounded text-xs font-mono"
                                            placeholder="Paste keywords here - supports multiple columns:&#10;yoga mat	10000	translation1&#10;exercise mat	5000	translation2&#10;(matches your custom columns in order)"
                                        />
                                        <button
                                            onClick={() => {
                                                if (!keywordInput.trim()) return;
                                                
                                                const lines = keywordInput.trim().split('\n');
                                                const newTableData = [];
                                                
                                                lines.forEach(line => {
                                                    line = line.trim();
                                                    if (!line) return;
                                                    
                                                    let parts = [];
                                                    
                                                    // Parse different formats (space, tab, comma)
                                                    if (line.includes('\t')) {
                                                        parts = line.split('\t').map(p => p.trim());
                                                    } else if (line.includes(',')) {
                                                        parts = line.split(',').map(p => p.trim());
                                                    } else {
                                                        parts = line.split(/\s+/);
                                                    }
                                                    
                                                    // Filter empty parts
                                                    parts = parts.filter(p => p);
                                                    
                                                    if (parts.length === 0) return;
                                                    
                                                    let term = '';
                                                    let volume = '';
                                                    const customData = {};
                                                    
                                                    // Check if we have tab or comma separated (easier to parse)
                                                    if (line.includes('\t') || line.includes(',')) {
                                                        term = parts[0] || '';
                                                        volume = parts[1] || '';
                                                        
                                                        // Map remaining parts to custom columns
                                                        for (let i = 2; i < parts.length && i - 2 < customColumns.length; i++) {
                                                            const colName = customColumns[i - 2];
                                                            customData[colName] = parts[i];
                                                        }
                                                    } else {
                                                        // Space separated - need to figure out where volume is
                                                        // Try to find a number that could be volume
                                                        let volumeIndex = -1;
                                                        for (let i = 0; i < parts.length; i++) {
                                                            if (!isNaN(parts[i]) && parts[i].match(/^\d+$/)) {
                                                                volumeIndex = i;
                                                                break;
                                                            }
                                                        }
                                                        
                                                        if (volumeIndex !== -1) {
                                                            // Found volume
                                                            term = parts.slice(0, volumeIndex).join(' ');
                                                            volume = parts[volumeIndex];
                                                            
                                                            // Remaining parts are custom columns
                                                            const remainingParts = parts.slice(volumeIndex + 1);
                                                            for (let i = 0; i < remainingParts.length && i < customColumns.length; i++) {
                                                                customData[customColumns[i]] = remainingParts[i];
                                                            }
                                                        } else {
                                                            // No volume found, just keyword
                                                            term = line;
                                                            volume = '';
                                                        }
                                                    }
                                                    
                                                    if (term.trim()) {
                                                        newTableData.push({ 
                                                            term: term.trim(), 
                                                            volume: volume, 
                                                            custom: customData 
                                                        });
                                                    }
                                                });
                                                
                                                if (newTableData.length > 0) {
                                                    setTableData(newTableData);
                                                    setKeywordInput('');
                                                    setSelectedRows(new Set());
                                                    alert(`Imported ${newTableData.length} keywords to table with ${Object.keys(newTableData[0].custom).length} custom columns!`);
                                                }
                                            }}
                                            className="mt-2 px-3 py-1 text-xs bg-blue-500 text-white rounded hover:bg-blue-600"
                                        >
                                            Import to Table
                                        </button>
                                        <p className="text-xs text-gray-600 mt-2">
                                            ðŸ’¡ Use tabs or commas to separate columns for best results. Extra columns will map to your custom columns in order.
                                        </p>
                                    </div>
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                                        ðŸš« Existing Keywords to Exclude (optional)
                                    </label>
                                    <textarea
                                        value={existingKeywords}
                                        onChange={(e) => setExistingKeywords(e.target.value)}
                                        className="w-full h-24 p-4 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none font-mono text-sm"
                                        placeholder="yoga mat&#10;exercise mat"
                                    />
                                    <p className="text-xs text-gray-500 mt-2">
                                        Keywords will be auto-excluded when loaded. Use the "Exclude Existing Keywords" button in Quick Actions to reapply after loading.
                                    </p>
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                                        ðŸ·ï¸ Brand Names to Exclude from Roots (optional)
                                    </label>
                                    <textarea
                                        value={brandList}
                                        onChange={(e) => setBrandList(e.target.value)}
                                        className="w-full h-24 p-4 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none font-mono text-sm"
                                        placeholder="nike&#10;adidas&#10;amazon basics"
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                                        ðŸ“¦ Product Description (for smart suggestions)
                                    </label>
                                    <textarea
                                        value={productDescription}
                                        onChange={(e) => setProductDescription(e.target.value)}
                                        className="w-full h-24 p-4 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none text-sm"
                                        placeholder="Premium yoga mats for fitness enthusiasts..."
                                    />
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-2">
                                        ðŸŒ Keyword Language (for AI analysis)
                                    </label>
                                    <select
                                        value={keywordLanguage}
                                        onChange={(e) => setKeywordLanguage(e.target.value)}
                                        className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none text-sm"
                                    >
                                        <option value="multi">Mixed Languages (Auto-detect)</option>
                                        <option value="german">German (Deutsch)</option>
                                        <option value="english">English</option>
                                        <option value="french">French (FranÃ§ais)</option>
                                        <option value="spanish">Spanish (EspaÃ±ol)</option>
                                        <option value="italian">Italian (Italiano)</option>
                                        <option value="dutch">Dutch (Nederlands)</option>
                                        <option value="polish">Polish (Polski)</option>
                                    </select>
                                    <p className="text-xs text-gray-500 mt-1">
                                        Select the primary language of your keywords for better AI analysis
                                    </p>
                                </div>

                                <div className="flex items-center space-x-3">
                                    <input
                                        type="checkbox"
                                        id="mergeMode"
                                        checked={mergeMode}
                                        onChange={(e) => setMergeMode(e.target.checked)}
                                        className="w-4 h-4"
                                    />
                                    <label htmlFor="mergeMode" className="text-sm text-gray-700">
                                        Merge mode (keep existing campaigns, add new keywords)
                                    </label>
                                </div>

                                <div className="flex gap-3">
                                    {keywords.length > 0 && (
                                        <button
                                            onClick={() => setShowSetup(false)}
                                            className="flex-1 bg-gray-200 text-gray-700 py-4 rounded-lg font-bold text-lg hover:bg-gray-300 transition"
                                        >
                                            â† Back
                                        </button>
                                    )}
                                    <button
                                        onClick={loadKeywords}
                                        className={`${keywords.length > 0 ? 'flex-1' : 'w-full'} bg-gradient-to-r from-purple-600 to-blue-600 text-white py-4 rounded-lg font-bold text-lg hover:from-purple-700 hover:to-blue-700 transition shadow-lg`}
                                    >
                                        ðŸš€ {keywords.length > 0 ? 'Update Keywords' : 'Load Keywords & Start Building'}
                                    </button>
                                </div>

                                {/* Clear saved data option */}
                                {savedStateExists && (
                                    <div className="text-center">
                                        <button
                                            onClick={() => {
                                                if (confirm('Are you sure you want to clear your saved session data?')) {
                                                    clearSavedState();
                                                    setSavedStateExists(false);
                                                    alert('Saved data cleared successfully.');
                                                }
                                            }}
                                            className="text-sm text-red-600 hover:text-red-800 underline"
                                        >
                                            ðŸ—‘ï¸ Clear Saved Session Data
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-100">
                    {/* Header */}
                    <div className="gradient-bg text-white py-6 px-8 shadow-lg">
                        <div className="max-w-7xl mx-auto">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-3xl font-bold">ðŸŽ¯ PPC Campaign Builder V7</h1>
                                    <p className="text-purple-200 text-sm mt-1">Auto-Assign Edition</p>
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setShowSetup(true)}
                                        className="bg-white text-purple-600 px-4 py-2 rounded-lg font-semibold hover:bg-purple-50"
                                    >
                                        âš™ï¸ Setup
                                    </button>
                                    <button
                                        onClick={exportData}
                                        className="bg-green-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-600"
                                    >
                                        ðŸ“¥ Export
                                    </button>
                                </div>
                            </div>

                            {/* Stats Bar */}
                            <div className="grid grid-cols-5 gap-4 mt-6">
                                <div className="bg-white bg-opacity-20 rounded-lg p-3 text-center">
                                    <div className="text-2xl font-bold">{stats.total}</div>
                                    <div className="text-sm text-purple-200">Total Keywords</div>
                                </div>
                                <div className="bg-white bg-opacity-20 rounded-lg p-3 text-center">
                                    <div className="text-2xl font-bold">{stats.assigned}</div>
                                    <div className="text-sm text-purple-200">Assigned</div>
                                </div>
                                <div className="bg-white bg-opacity-20 rounded-lg p-3 text-center">
                                    <div className="text-2xl font-bold">{stats.unassigned}</div>
                                    <div className="text-sm text-purple-200">Unassigned</div>
                                </div>
                                <div className="bg-white bg-opacity-20 rounded-lg p-3 text-center">
                                    <div className="text-2xl font-bold">{stats.excluded}</div>
                                    <div className="text-sm text-purple-200">Excluded</div>
                                </div>
                                <div className="bg-white bg-opacity-20 rounded-lg p-3 text-center">
                                    <div className="text-2xl font-bold">{stats.totalVolume.toLocaleString()}</div>
                                    <div className="text-sm text-purple-200">Total Volume</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="max-w-7xl mx-auto p-6">
                        <div className="grid grid-cols-3 gap-6">
                            {/* Left Column - Keywords */}
                            <div className="col-span-2 space-y-4">
                                {/* Filters */}
                                <div className="bg-white rounded-lg shadow p-4">
                                    <h2 className="text-lg font-bold text-gray-800 mb-3">ðŸ” Filters & Search</h2>
                                    
                                    <div className="grid grid-cols-4 gap-3 mb-3">
                                        <div>
                                            <label className="block text-xs text-gray-600 mb-1">Assignment Status</label>
                                            <select
                                                value={assignmentFilter}
                                                onChange={(e) => setAssignmentFilter(e.target.value)}
                                                className="w-full p-2 border border-gray-300 rounded text-sm focus:border-purple-500 focus:outline-none"
                                            >
                                                <option value="all">All Keywords</option>
                                                <option value="assigned">Assigned Only</option>
                                                <option value="unassigned">Unassigned Only</option>
                                                <option value="excluded">Excluded Only</option>
                                                <option value="included">Included Only</option>
                                            </select>
                                        </div>

                                        <div className="relative">
                                            <label className="block text-xs text-gray-600 mb-1">Root Filter</label>
                                            <button
                                                onClick={() => setShowRootDropdown(!showRootDropdown)}
                                                className="w-full p-2 border border-gray-300 rounded text-sm text-left focus:border-purple-500 focus:outline-none bg-white hover:bg-gray-50"
                                            >
                                                {rootFilter.has('all') 
                                                    ? `All Roots (${allRoots.length})`
                                                    : `${rootFilter.size} selected`}
                                            </button>
                                            
                                            {showRootDropdown && (
                                                <div className="absolute z-50 mt-1 w-full bg-white border border-gray-300 rounded-lg shadow-lg max-h-96 overflow-hidden">
                                                    {/* Search Input */}
                                                    <div className="p-2 border-b border-gray-200 sticky top-0 bg-white">
                                                        <input
                                                            type="text"
                                                            value={rootSearchFilter}
                                                            onChange={(e) => setRootSearchFilter(e.target.value)}
                                                            placeholder="ðŸ” Search roots..."
                                                            className="w-full p-2 border border-gray-300 rounded text-sm focus:border-purple-500 focus:outline-none"
                                                            onClick={(e) => e.stopPropagation()}
                                                        />
                                                    </div>
                                                    
                                                    {/* Quick Actions */}
                                                    <div className="p-2 border-b border-gray-200 flex gap-2 bg-gray-50">
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                setRootFilter(new Set(['all']));
                                                            }}
                                                            className="flex-1 px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-semibold hover:bg-blue-200"
                                                        >
                                                            âœ“ All
                                                        </button>
                                                        <button
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                setRootFilter(new Set());
                                                            }}
                                                            className="flex-1 px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs font-semibold hover:bg-gray-300"
                                                        >
                                                            âœ— Clear
                                                        </button>
                                                    </div>
                                                    
                                                    {/* Root Options */}
                                                    <div className="overflow-y-auto max-h-80 scrollbar-thin">
                                                        {/* All Roots Option */}
                                                        <label 
                                                            className="flex items-center p-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100"
                                                            onClick={(e) => e.stopPropagation()}
                                                        >
                                                            <input
                                                                type="checkbox"
                                                                checked={rootFilter.has('all')}
                                                                onChange={(e) => {
                                                                    e.stopPropagation();
                                                                    if (e.target.checked) {
                                                                        setRootFilter(new Set(['all']));
                                                                    } else {
                                                                        setRootFilter(new Set());
                                                                    }
                                                                }}
                                                                className="mr-2 w-4 h-4"
                                                            />
                                                            <span className="text-sm font-semibold text-blue-600">
                                                                All Roots ({allRoots.length})
                                                            </span>
                                                        </label>
                                                        
                                                        {/* Individual Root Options */}
                                                        {allRoots
                                                            .filter(r => 
                                                                !rootSearchFilter || 
                                                                r.root.toLowerCase().includes(rootSearchFilter.toLowerCase())
                                                            )
                                                            .map(r => (
                                                                <label 
                                                                    key={r.root}
                                                                    className="flex items-center p-2 hover:bg-gray-50 cursor-pointer"
                                                                    onClick={(e) => e.stopPropagation()}
                                                                >
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={rootFilter.has(r.root) || rootFilter.has('all')}
                                                                        disabled={rootFilter.has('all')}
                                                                        onChange={(e) => {
                                                                            e.stopPropagation();
                                                                            const newFilter = new Set(rootFilter);
                                                                            newFilter.delete('all'); // Remove 'all' when selecting individual items
                                                                            
                                                                            if (e.target.checked) {
                                                                                newFilter.add(r.root);
                                                                            } else {
                                                                                newFilter.delete(r.root);
                                                                            }
                                                                            
                                                                            // If nothing selected, default to 'all'
                                                                            if (newFilter.size === 0) {
                                                                                newFilter.add('all');
                                                                            }
                                                                            
                                                                            setRootFilter(newFilter);
                                                                        }}
                                                                        className="mr-2 w-4 h-4 flex-shrink-0"
                                                                    />
                                                                    <span className="text-sm flex-1 min-w-0 truncate">
                                                                        {r.root}
                                                                    </span>
                                                                    <span className="text-xs text-gray-500 ml-2 whitespace-nowrap flex-shrink-0">
                                                                        {r.count} kw, {r.volume.toLocaleString()} vol
                                                                    </span>
                                                                </label>
                                                            ))
                                                        }
                                                    </div>
                                                </div>
                                            )}
                                        </div>

                                        <div>
                                            <label className="block text-xs text-gray-600 mb-1">Sort By</label>
                                            <select
                                                value={sortBy}
                                                onChange={(e) => setSortBy(e.target.value)}
                                                className="w-full p-2 border border-gray-300 rounded text-sm focus:border-purple-500 focus:outline-none"
                                            >
                                                <option value="volume-desc">Volume (High â†’ Low)</option>
                                                <option value="volume-asc">Volume (Low â†’ High)</option>
                                                <option value="alpha-asc">Alphabetical (A â†’ Z)</option>
                                                <option value="alpha-desc">Alphabetical (Z â†’ A)</option>
                                                <option value="roots-desc">Most Roots First</option>
                                                <option value="roots-asc">Fewest Roots First</option>
                                            </select>
                                        </div>

                                        <div>
                                            <label className="block text-xs text-gray-600 mb-1">Campaign Filter</label>
                                            <select
                                                value={campaignFilter}
                                                onChange={(e) => setCampaignFilter(e.target.value)}
                                                className="w-full p-2 border border-gray-300 rounded text-sm focus:border-purple-500 focus:outline-none"
                                            >
                                                <option value="all">All Campaigns</option>
                                                {campaigns.map(campaign => (
                                                    <option key={campaign.id} value={campaign.id}>
                                                        {campaign.name}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-3 mb-3">
                                        <div>
                                            <label className="block text-xs text-gray-600 mb-1">Volume Range</label>
                                            <div className="grid grid-cols-2 gap-2">
                                                <input
                                                    type="number"
                                                    placeholder="Min"
                                                    value={volumeMin}
                                                    onChange={(e) => setVolumeMin(e.target.value)}
                                                    className="w-full p-2 border border-gray-300 rounded text-sm focus:border-purple-500 focus:outline-none"
                                                />
                                                <input
                                                    type="number"
                                                    placeholder="Max"
                                                    value={volumeMax}
                                                    onChange={(e) => setVolumeMax(e.target.value)}
                                                    className="w-full p-2 border border-gray-300 rounded text-sm focus:border-purple-500 focus:outline-none"
                                                />
                                            </div>
                                        </div>

                                        <div>
                                            <label className="block text-xs text-gray-600 mb-1">Root Frequency Filter</label>
                                            <div className="grid grid-cols-2 gap-2">
                                                <input
                                                    type="number"
                                                    placeholder="Min mentions"
                                                    value={rootCountMin}
                                                    onChange={(e) => setRootCountMin(e.target.value)}
                                                    className="w-full p-2 border border-gray-300 rounded text-sm focus:border-purple-500 focus:outline-none"
                                                />
                                                <input
                                                    type="number"
                                                    placeholder="Max mentions"
                                                    value={rootCountMax}
                                                    onChange={(e) => setRootCountMax(e.target.value)}
                                                    className="w-full p-2 border border-gray-300 rounded text-sm focus:border-purple-500 focus:outline-none"
                                                />
                                            </div>
                                            <p className="text-xs text-gray-500 mt-1">Filter by how many times root appears</p>
                                        </div>
                                    </div>

                                    <input
                                        type="text"
                                        value={searchFilter}
                                        onChange={(e) => setSearchFilter(e.target.value)}
                                        placeholder="ðŸ” Search keywords..."
                                        className="w-full p-2 border border-gray-300 rounded text-sm focus:border-purple-500 focus:outline-none"
                                    />

                                    {selectedKeywords.size > 0 && (
                                        <div className="mt-3 p-3 bg-blue-50 border border-blue-200 rounded">
                                            <div className="flex flex-col gap-2">
                                                <div className="flex justify-between items-center">
                                                    <span className="text-sm font-semibold text-blue-800">
                                                        {selectedKeywords.size} selected
                                                    </span>
                                                    <button
                                                        onClick={() => setSelectedKeywords(new Set())}
                                                        className="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600"
                                                    >
                                                        Clear
                                                    </button>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div className="flex gap-2">
                                                        <select
                                                            className="flex-1 p-1.5 border border-gray-300 rounded text-sm"
                                                            id="bulkAssignCampaign"
                                                        >
                                                            <option value="">Assign to...</option>
                                                            {campaigns.map(c => (
                                                                <option key={c.id} value={c.id}>{c.name}</option>
                                                            ))}
                                                        </select>
                                                        <button
                                                            onClick={() => {
                                                                const campaignId = document.getElementById('bulkAssignCampaign').value;
                                                                if (campaignId) bulkAssignSelected(parseInt(campaignId));
                                                            }}
                                                            className="bg-blue-600 text-white px-3 py-1.5 rounded text-sm font-semibold hover:bg-blue-700 whitespace-nowrap"
                                                        >
                                                            Assign
                                                        </button>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={bulkUnassignSelected}
                                                            className="flex-1 bg-orange-600 text-white px-3 py-1.5 rounded text-sm font-semibold hover:bg-orange-700"
                                                        >
                                                            Unassign
                                                        </button>
                                                        <button
                                                            onClick={bulkExcludeSelected}
                                                            className="flex-1 bg-red-600 text-white px-3 py-1.5 rounded text-sm font-semibold hover:bg-red-700"
                                                        >
                                                            Exclude
                                                        </button>
                                                        <button
                                                            onClick={bulkIncludeSelected}
                                                            className="flex-1 bg-green-600 text-white px-3 py-1.5 rounded text-sm font-semibold hover:bg-green-700"
                                                        >
                                                            Include
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Keywords Table */}
                                <div className="bg-white rounded-lg shadow overflow-hidden">
                                    <div className="max-h-[600px] overflow-y-auto scrollbar-thin">
                                        <table className="w-full">
                                            <thead className="sticky-header bg-gray-50 border-b-2 border-gray-200">
                                                <tr>
                                                    <th className="px-3 py-2 text-left text-xs font-semibold text-gray-600 w-8">
                                                        <input
                                                            type="checkbox"
                                                            onChange={(e) => {
                                                                if (e.target.checked) {
                                                                    const selectable = filteredKeywords
                                                                        .filter(k => !k.excluded)
                                                                        .map(k => k.id);
                                                                    setSelectedKeywords(new Set(selectable));
                                                                } else {
                                                                    setSelectedKeywords(new Set());
                                                                }
                                                            }}
                                                        />
                                                    </th>
                                                    <th className="px-3 py-2 text-left text-xs font-semibold text-gray-600">Keyword</th>
                                                    <th className="px-3 py-2 text-left text-xs font-semibold text-gray-600 w-24">Volume</th>
                                                    <th className="px-3 py-2 text-left text-xs font-semibold text-gray-600 w-32">Roots</th>
                                                    {customColumns.map((col, idx) => (
                                                        <th key={idx} className="px-3 py-2 text-left text-xs font-semibold text-gray-600 w-40">
                                                            {col}
                                                        </th>
                                                    ))}
                                                    <th className="px-3 py-2 text-left text-xs font-semibold text-gray-600 w-40">Campaign</th>
                                                    <th className="px-3 py-2 text-left text-xs font-semibold text-gray-600 w-24">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {filteredKeywords.map(kw => {
                                                    const campaign = campaigns.find(c => c.id === kw.campaignId);
                                                    
                                                    return (
                                                        <tr key={kw.id} className={`border-b table-row ${
                                                            kw.excluded ? 'bg-red-50 opacity-60' :
                                                            kw.isExisting ? 'bg-yellow-50' :
                                                            kw.campaignId ? 'bg-green-50' : ''
                                                        }`}>
                                                            <td className="px-3 py-2">
                                                                {!kw.excluded && (
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={selectedKeywords.has(kw.id)}
                                                                        onChange={() => toggleKeywordSelection(kw.id)}
                                                                    />
                                                                )}
                                                            </td>
                                                            <td className="px-3 py-2 text-sm">
                                                                {kw.keyword}
                                                                {kw.isExisting && (
                                                                    <span className="ml-2 text-xs bg-yellow-200 text-yellow-800 px-2 py-0.5 rounded">
                                                                        existing
                                                                    </span>
                                                                )}
                                                            </td>
                                                            <td className="px-3 py-2 text-sm font-semibold">
                                                                {kw.volume.toLocaleString()}
                                                            </td>
                                                            <td className="px-3 py-2 text-xs">
                                                                <span className="bg-gray-200 text-gray-700 px-2 py-0.5 rounded">
                                                                    {kw.roots.length} roots
                                                                </span>
                                                            </td>
                                                            {customColumns.map((col, idx) => (
                                                                <td key={idx} className="px-3 py-2 text-sm text-gray-600">
                                                                    {kw.customData?.[col] || '-'}
                                                                </td>
                                                            ))}
                                                            <td className="px-3 py-2">
                                                                <select
                                                                    value={kw.campaignId || ''}
                                                                    onChange={(e) => assignKeyword(kw.id, e.target.value ? parseInt(e.target.value) : null)}
                                                                    disabled={kw.excluded}
                                                                    className="w-full p-1 border border-gray-300 rounded text-xs focus:border-purple-500 focus:outline-none"
                                                                >
                                                                    <option value="">Unassigned</option>
                                                                    {campaigns.map(c => (
                                                                        <option key={c.id} value={c.id}>{c.name}</option>
                                                                    ))}
                                                                </select>
                                                            </td>
                                                            <td className="px-3 py-2">
                                                                <button
                                                                    onClick={() => excludeKeyword(kw.id)}
                                                                    className={`text-xs px-2 py-1 rounded ${
                                                                        kw.excluded 
                                                                            ? 'bg-green-100 text-green-700 hover:bg-green-200' 
                                                                            : 'bg-red-100 text-red-700 hover:bg-red-200'
                                                                    }`}
                                                                >
                                                                    {kw.excluded ? 'âœ“ Include' : 'âœ— Exclude'}
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* Smart Suggestions */}
                                {showSuggestions && smartSuggestions.length > 0 && (
                                    <div className="bg-white rounded-lg shadow p-4">
                                        <div className="flex justify-between items-center mb-3">
                                            <div>
                                                <h3 className="text-lg font-bold text-gray-800">ðŸ” Potentially Irrelevant Keywords</h3>
                                                <p className="text-xs text-gray-600 mt-1">
                                                    These keywords don't match your product description. Review and exclude if needed.
                                                </p>
                                            </div>
                                            <button
                                                onClick={() => setShowSuggestions(false)}
                                                className="text-gray-500 hover:text-gray-700"
                                            >
                                                âœ•
                                            </button>
                                        </div>
                                        
                                        <div className="space-y-2 max-h-96 overflow-y-auto">
                                            {smartSuggestions.map((s, i) => (
                                                <div key={i} className="flex items-center justify-between p-3 bg-orange-50 border border-orange-200 rounded">
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-sm font-semibold">{s.keyword}</span>
                                                            <span className="text-xs bg-orange-200 text-orange-800 px-2 py-0.5 rounded">
                                                                {s.volume.toLocaleString()} vol
                                                            </span>
                                                        </div>
                                                        <div className="text-xs text-gray-600 mt-1">
                                                            {s.reason}
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-2 ml-4">
                                                        <button
                                                            onClick={() => excludeSuggestion(s)}
                                                            className="bg-red-500 text-white px-3 py-1.5 rounded text-xs font-semibold hover:bg-red-600 whitespace-nowrap"
                                                        >
                                                            âœ— Exclude
                                                        </button>
                                                        <button
                                                            onClick={() => keepSuggestion(s)}
                                                            className="bg-green-500 text-white px-3 py-1.5 rounded text-xs font-semibold hover:bg-green-600 whitespace-nowrap"
                                                        >
                                                            âœ“ Keep
                                                        </button>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Right Column - Campaigns & Actions */}
                            <div className="space-y-4">
                                {/* Campaigns */}
                                <div className="bg-white rounded-lg shadow">
                                    <div className="p-4 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-blue-50">
                                        <div className="flex justify-between items-center">
                                            <h2 className="text-lg font-bold text-gray-800">ðŸ“‹ Campaigns</h2>
                                            <button
                                                onClick={addCampaign}
                                                className="bg-purple-600 text-white px-3 py-1 rounded text-sm font-semibold hover:bg-purple-700"
                                            >
                                                + New
                                            </button>
                                        </div>
                                    </div>

                                    <div className="max-h-96 overflow-y-auto scrollbar-thin">
                                        {campaigns.map(campaign => {
                                            const stats = campaignStats.find(s => s.id === campaign.id) || { count: 0, volume: 0 };
                                            const exceedsKeywords = stats.count > campaign.maxKeywords;
                                            const exceedsVolume = stats.volume < campaign.minVolume || stats.volume > campaign.maxVolume;
                                            
                                            return (
                                                <div key={campaign.id} className="p-4 border-b border-gray-200 hover:bg-gray-50">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <input
                                                            type="text"
                                                            value={campaign.name}
                                                            onChange={(e) => updateCampaign(campaign.id, 'name', e.target.value)}
                                                            className="flex-1 font-semibold text-sm p-1 border border-gray-300 rounded focus:border-purple-500 focus:outline-none"
                                                        />
                                                        <button
                                                            onClick={() => removeCampaign(campaign.id)}
                                                            className="ml-2 text-red-500 hover:text-red-700 text-sm"
                                                        >
                                                            ðŸ—‘ï¸
                                                        </button>
                                                    </div>

                                                    <div className="space-y-2">
                                                        <div>
                                                            <label className="block text-xs text-gray-600 mb-1">Match Type</label>
                                                            <select
                                                                value={campaign.matchType}
                                                                onChange={(e) => updateCampaign(campaign.id, 'matchType', e.target.value)}
                                                                className="w-full p-1.5 border border-gray-300 rounded text-sm focus:border-purple-500 focus:outline-none"
                                                            >
                                                                <option>Exact</option>
                                                                <option>Phrase</option>
                                                                <option>Broad</option>
                                                            </select>
                                                        </div>

                                                        <div>
                                                            <label className="block text-xs text-gray-600 mb-1">Max Keywords</label>
                                                            <input
                                                                type="number"
                                                                value={campaign.maxKeywords}
                                                                onChange={(e) => updateCampaign(campaign.id, 'maxKeywords', parseInt(e.target.value) || 1)}
                                                                className="w-full p-1.5 border border-gray-300 rounded text-sm focus:border-purple-500 focus:outline-none"
                                                            />
                                                        </div>

                                                        <div>
                                                            <label className="block text-xs text-gray-600 mb-1">Volume Range</label>
                                                            <div className="grid grid-cols-2 gap-2">
                                                                <input
                                                                    type="number"
                                                                    placeholder="Min"
                                                                    value={campaign.minVolume}
                                                                    onChange={(e) => updateCampaign(campaign.id, 'minVolume', parseInt(e.target.value) || 0)}
                                                                    className="w-full p-1.5 border border-gray-300 rounded text-sm focus:border-purple-500 focus:outline-none"
                                                                />
                                                                <input
                                                                    type="number"
                                                                    placeholder="Max"
                                                                    value={campaign.maxVolume}
                                                                    onChange={(e) => updateCampaign(campaign.id, 'maxVolume', parseInt(e.target.value) || 999999)}
                                                                    className="w-full p-1.5 border border-gray-300 rounded text-sm focus:border-purple-500 focus:outline-none"
                                                                />
                                                            </div>
                                                        </div>

                                                        <div className={`p-2 rounded text-xs ${
                                                            exceedsKeywords || exceedsVolume ? 'bg-yellow-100 border border-yellow-400' : 'bg-green-100 border border-green-400'
                                                        }`}>
                                                            <div className="flex justify-between mb-1">
                                                                <span>Keywords:</span>
                                                                <span className={`font-semibold ${exceedsKeywords ? 'text-orange-700' : 'text-green-700'}`}>
                                                                    {stats.count} / {campaign.maxKeywords}
                                                                </span>
                                                            </div>
                                                            <div className="flex justify-between">
                                                                <span>Volume:</span>
                                                                <span className={`font-semibold ${exceedsVolume ? 'text-orange-700' : 'text-green-700'}`}>
                                                                    {stats.volume.toLocaleString()}
                                                                </span>
                                                            </div>
                                                            {(exceedsKeywords || exceedsVolume) && (
                                                                <div className="mt-1 text-orange-700 font-semibold">
                                                                    âš ï¸ Exceeds limits
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                {/* Quick Actions */}
                                <div className="bg-white rounded-lg shadow">
                                    <div className="p-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-purple-50">
                                        <h3 className="text-lg font-bold text-gray-800">âš¡ Quick Actions</h3>
                                    </div>

                                    <div className="p-4 space-y-4">
                                        {/* Auto-Assign by Volume */}
                                        <div>
                                            <button
                                                onClick={openAutoAssign}
                                                className="w-full bg-gradient-to-r from-orange-500 to-pink-500 text-white px-4 py-3 rounded-lg font-bold hover:from-orange-600 hover:to-pink-600 shadow-md"
                                            >
                                                ðŸŽ¯ Auto-Assign by Search Volume
                                            </button>
                                            <p className="text-xs text-gray-500 mt-1 text-center">
                                                Split roots into campaigns by volume %
                                            </p>
                                        </div>

                                        {/* Reapply Existing Keywords */}
                                        {existingKeywords.trim() && (
                                            <div>
                                                <button
                                                    onClick={reapplyExistingKeywords}
                                                    className="w-full bg-red-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-700"
                                                >
                                                    ðŸš« Exclude Existing Keywords
                                                </button>
                                                <p className="text-xs text-gray-500 mt-1 text-center">
                                                    Re-apply existing keywords exclusion
                                                </p>
                                            </div>
                                        )}

                                        {/* Bulk Assign Root */}
                                        <div>
                                            <label className="block text-xs font-semibold text-gray-600 mb-2">Bulk Assign Root</label>
                                            <div className="space-y-2">
                                                <select className="w-full p-2 border border-gray-300 rounded text-sm" id="bulkRoot">
                                                    <option value="">Select root...</option>
                                                    {allRoots.map(r => (
                                                        <option key={r.root} value={r.root}>
                                                            {r.root} ({r.count})
                                                        </option>
                                                    ))}
                                                </select>
                                                <select className="w-full p-2 border border-gray-300 rounded text-sm" id="bulkCampaign">
                                                    <option value="">To campaign...</option>
                                                    {campaigns.map(c => (
                                                        <option key={c.id} value={c.id}>{c.name}</option>
                                                    ))}
                                                </select>
                                                <button
                                                    onClick={() => {
                                                        const root = document.getElementById('bulkRoot').value;
                                                        const campaignId = document.getElementById('bulkCampaign').value;
                                                        if (root && campaignId) {
                                                            bulkAssignByRoot(root, parseInt(campaignId));
                                                        }
                                                    }}
                                                    className="w-full bg-blue-600 text-white px-3 py-2 rounded font-semibold hover:bg-blue-700"
                                                >
                                                    Assign (up to limit)
                                                </button>
                                            </div>
                                        </div>

                                        {/* Generate Suggestions */}
                                        <div>
                                            <button
                                                onClick={generateSuggestions}
                                                className="w-full bg-orange-600 text-white px-3 py-2 rounded font-semibold hover:bg-orange-700"
                                            >
                                                ðŸ” Find Irrelevant Keywords
                                            </button>
                                            <p className="text-xs text-gray-500 mt-1 text-center">
                                                AI-powered analysis (Claude)
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Auto-Assign Modal */}
                    {showAutoAssign && (
                        <div className="modal-overlay" onClick={() => setShowAutoAssign(false)}>
                            <div className="modal-content" onClick={(e) => e.stopPropagation()}>
                                <div className="p-6">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-2xl font-bold text-gray-800">
                                            ðŸŽ¯ Auto-Assign by Search Volume
                                        </h2>
                                        <button
                                            onClick={() => setShowAutoAssign(false)}
                                            className="text-gray-500 hover:text-gray-700 text-2xl"
                                        >
                                            âœ•
                                        </button>
                                    </div>

                                    {/* Global Settings */}
                                    <div className="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                        <h3 className="text-sm font-bold text-gray-800 mb-3">Global Settings (Optional)</h3>
                                        <div className="grid grid-cols-3 gap-3">
                                            <div>
                                                <label className="block text-xs text-gray-600 mb-1">Max Keywords per Campaign</label>
                                                <input
                                                    type="number"
                                                    placeholder="No limit"
                                                    value={autoAssignConfig.globalMaxKeywords}
                                                    onChange={(e) => setAutoAssignConfig({
                                                        ...autoAssignConfig,
                                                        globalMaxKeywords: e.target.value
                                                    })}
                                                    className="w-full p-2 border border-gray-300 rounded text-sm"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-xs text-gray-600 mb-1">Min Search Volume</label>
                                                <input
                                                    type="number"
                                                    placeholder="No min"
                                                    value={autoAssignConfig.globalMinVolume}
                                                    onChange={(e) => setAutoAssignConfig({
                                                        ...autoAssignConfig,
                                                        globalMinVolume: e.target.value
                                                    })}
                                                    className="w-full p-2 border border-gray-300 rounded text-sm"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-xs text-gray-600 mb-1">Max Search Volume</label>
                                                <input
                                                    type="number"
                                                    placeholder="No max"
                                                    value={autoAssignConfig.globalMaxVolume}
                                                    onChange={(e) => setAutoAssignConfig({
                                                        ...autoAssignConfig,
                                                        globalMaxVolume: e.target.value
                                                    })}
                                                    className="w-full p-2 border border-gray-300 rounded text-sm"
                                                />
                                            </div>
                                        </div>
                                    </div>

                                    {/* Root Selection */}
                                    <div className="mb-4">
                                        <h3 className="text-sm font-bold text-gray-800 mb-3">
                                            Select Roots to Process ({autoAssignConfig.selectedRoots.size} selected
                                            {autoAssignConfig.rootGroups.length > 0 && (
                                                <span className="text-teal-600">
                                                    {' '}+ {autoAssignConfig.rootGroups.reduce((sum, g) => sum + g.roots.size, 0)} in groups
                                                </span>
                                            )})
                                        </h3>
                                        
                                        {/* Search Box */}
                                        <div className="mb-2">
                                            <input
                                                type="text"
                                                value={autoAssignRootSearch}
                                                onChange={(e) => setAutoAssignRootSearch(e.target.value)}
                                                placeholder="ðŸ” Search roots..."
                                                className="w-full p-2 border border-gray-300 rounded text-sm focus:border-purple-500 focus:outline-none"
                                            />
                                        </div>
                                        
                                        <div className="max-h-64 overflow-y-auto border border-gray-300 rounded p-3 space-y-2">
                                            {allRoots
                                                .filter(rootData => 
                                                    !autoAssignRootSearch || 
                                                    rootData.root.toLowerCase().includes(autoAssignRootSearch.toLowerCase())
                                                )
                                                .map(rootData => {
                                                    // Check if this root is in any group
                                                    const inGroup = autoAssignConfig.rootGroups.find(g => g.roots.has(rootData.root));
                                                    const isSelected = autoAssignConfig.selectedRoots.has(rootData.root);
                                                    
                                                    return (
                                                        <div
                                                            key={rootData.root}
                                                            className={`p-3 rounded transition ${
                                                                isSelected
                                                                    ? 'bg-purple-100 border-2 border-purple-500 cursor-pointer'
                                                                    : inGroup
                                                                    ? 'bg-teal-50 border-2 border-teal-400 cursor-not-allowed opacity-75'
                                                                    : 'bg-gray-50 border border-gray-300 hover:bg-gray-100 cursor-pointer'
                                                            }`}
                                                            onClick={() => !inGroup && toggleRootSelection(rootData.root)}
                                                        >
                                                            <div className="flex items-center justify-between">
                                                                <div className="flex items-center gap-3 flex-1">
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={isSelected}
                                                                        onChange={() => {}}
                                                                        disabled={!!inGroup}
                                                                        className="w-4 h-4"
                                                                    />
                                                                    <div className="flex-1">
                                                                        <div className="flex items-center gap-2">
                                                                            <div className="font-semibold text-gray-800">{rootData.root}</div>
                                                                            {inGroup && (
                                                                                <span className="text-xs bg-teal-600 text-white px-2 py-0.5 rounded font-semibold">
                                                                                    ðŸ“¦ In: {inGroup.name}
                                                                                </span>
                                                                            )}
                                                                        </div>
                                                                        <div className="text-xs text-gray-600">
                                                                            {rootData.count} keywords â€¢ {rootData.volume.toLocaleString()} total volume
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                        </div>
                                        
                                        {/* Create Group Button */}
                                        {autoAssignConfig.selectedRoots.size >= 2 && (
                                            <div className="mt-3 flex gap-2">
                                                <button
                                                    onClick={() => {
                                                        const groupName = prompt('Enter a name for this group:', 
                                                            Array.from(autoAssignConfig.selectedRoots).slice(0, 3).join(' + ') + 
                                                            (autoAssignConfig.selectedRoots.size > 3 ? ` +${autoAssignConfig.selectedRoots.size - 3} more` : '')
                                                        );
                                                        if (groupName) {
                                                            const newGroup = {
                                                                id: Date.now(),
                                                                name: groupName,
                                                                roots: new Set(autoAssignConfig.selectedRoots),
                                                                campaigns: [
                                                                    { name: `${groupName} Campaign 1`, percentage: 100 }
                                                                ]
                                                            };
                                                            
                                                            // Remove individual configs for roots that are now in a group
                                                            const newRootConfigs = { ...autoAssignConfig.rootConfigs };
                                                            autoAssignConfig.selectedRoots.forEach(root => {
                                                                delete newRootConfigs[root];
                                                            });
                                                            
                                                            setAutoAssignConfig({
                                                                ...autoAssignConfig,
                                                                rootGroups: [...autoAssignConfig.rootGroups, newGroup],
                                                                selectedRoots: new Set(), // Clear selections after creating group
                                                                rootConfigs: newRootConfigs
                                                            });
                                                        }
                                                    }}
                                                    className="flex-1 bg-gradient-to-r from-green-500 to-teal-500 text-white px-4 py-2 rounded-lg font-bold hover:from-green-600 hover:to-teal-600"
                                                >
                                                    âž• Combine Selected into Group
                                                </button>
                                            </div>
                                        )}
                                    </div>

                                    {/* Root Groups */}
                                    {autoAssignConfig.rootGroups.length > 0 && (
                                        <div className="mb-4">
                                            <h3 className="text-sm font-bold text-gray-800 mb-3">
                                                ðŸ“¦ Combined Root Groups ({autoAssignConfig.rootGroups.length})
                                            </h3>
                                            <div className="space-y-2">
                                                {autoAssignConfig.rootGroups.map(group => {
                                                    const groupKeywords = keywords.filter(kw => 
                                                        !kw.excluded && 
                                                        kw.campaignId === null &&
                                                        kw.roots.some(root => group.roots.has(root))
                                                    );
                                                    const totalVolume = groupKeywords.reduce((sum, kw) => sum + kw.volume, 0);
                                                    
                                                    return (
                                                        <div key={group.id} className="p-4 bg-teal-50 border-2 border-teal-500 rounded-lg">
                                                            <div className="flex items-start justify-between mb-3">
                                                                <div className="flex-1">
                                                                    <div className="font-semibold text-gray-800 text-lg mb-2">{group.name}</div>
                                                                    
                                                                    {/* Roots Display with Remove Buttons */}
                                                                    <div className="mb-2">
                                                                        <div className="text-xs font-semibold text-gray-700 mb-1">Roots in this group:</div>
                                                                        <div className="flex flex-wrap gap-2">
                                                                            {Array.from(group.roots).map(root => (
                                                                                <div key={root} className="flex items-center gap-1 bg-teal-600 text-white px-2 py-1 rounded text-xs">
                                                                                    <span>{root}</span>
                                                                                    {group.roots.size > 1 && (
                                                                                        <button
                                                                                            onClick={() => {
                                                                                                const updatedRoots = new Set(group.roots);
                                                                                                updatedRoots.delete(root);
                                                                                                const updatedGroups = autoAssignConfig.rootGroups.map(g => 
                                                                                                    g.id === group.id ? { ...g, roots: updatedRoots } : g
                                                                                                );
                                                                                                setAutoAssignConfig({
                                                                                                    ...autoAssignConfig,
                                                                                                    rootGroups: updatedGroups
                                                                                                });
                                                                                            }}
                                                                                            className="ml-1 text-white hover:text-red-200 font-bold"
                                                                                            title="Remove this root"
                                                                                        >
                                                                                            Ã—
                                                                                        </button>
                                                                                    )}
                                                                                </div>
                                                                            ))}
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    {/* Add Root Dropdown */}
                                                                    <div className="mt-2 flex items-center gap-2">
                                                                        <select 
                                                                            className="text-xs p-1 border border-teal-600 rounded"
                                                                            onChange={(e) => {
                                                                                const rootToAdd = e.target.value;
                                                                                if (rootToAdd) {
                                                                                    const updatedRoots = new Set(group.roots);
                                                                                    updatedRoots.add(rootToAdd);
                                                                                    const updatedGroups = autoAssignConfig.rootGroups.map(g => 
                                                                                        g.id === group.id ? { ...g, roots: updatedRoots } : g
                                                                                    );
                                                                                    setAutoAssignConfig({
                                                                                        ...autoAssignConfig,
                                                                                        rootGroups: updatedGroups
                                                                                    });
                                                                                    e.target.value = ''; // Reset selection
                                                                                }
                                                                            }}
                                                                            defaultValue=""
                                                                        >
                                                                            <option value="">âž• Add another root...</option>
                                                                            {allRoots
                                                                                .filter(r => {
                                                                                    // Don't show if already in this group
                                                                                    if (group.roots.has(r.root)) return false;
                                                                                    // Don't show if in another group
                                                                                    const inAnotherGroup = autoAssignConfig.rootGroups.some(
                                                                                        g => g.id !== group.id && g.roots.has(r.root)
                                                                                    );
                                                                                    if (inAnotherGroup) return false;
                                                                                    // Don't show if selected individually
                                                                                    if (autoAssignConfig.selectedRoots.has(r.root)) return false;
                                                                                    return true;
                                                                                })
                                                                                .map(r => (
                                                                                    <option key={r.root} value={r.root}>
                                                                                        {r.root} ({r.count} kw, {r.volume.toLocaleString()} vol)
                                                                                    </option>
                                                                                ))
                                                                            }
                                                                        </select>
                                                                    </div>
                                                                    
                                                                    <div className="text-xs text-teal-700 font-semibold mt-2">
                                                                        {groupKeywords.length} keywords â€¢ {totalVolume.toLocaleString()} total volume
                                                                    </div>
                                                                </div>
                                                                <button
                                                                    onClick={() => {
                                                                        if (confirm(`Delete group "${group.name}"?`)) {
                                                                            setAutoAssignConfig({
                                                                                ...autoAssignConfig,
                                                                                rootGroups: autoAssignConfig.rootGroups.filter(g => g.id !== group.id)
                                                                            });
                                                                        }
                                                                    }}
                                                                    className="ml-2 px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 text-sm font-semibold"
                                                                >
                                                                    Delete
                                                                </button>
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    )}

                                    {/* Configuration for Selected Roots */}
                                    {autoAssignConfig.selectedRoots.size > 0 && (
                                        <div className="space-y-4 mb-6">
                                            <h3 className="text-sm font-bold text-gray-800">Campaign Configuration</h3>
                                            {Array.from(autoAssignConfig.selectedRoots).map(root => {
                                                const config = autoAssignConfig.rootConfigs[root];
                                                const rootData = allRoots.find(r => r.root === root);
                                                
                                                if (!config || !rootData) return null;

                                                return (
                                                    <div key={root} className="border border-gray-300 rounded-lg p-4 bg-white">
                                                        <div className="flex justify-between items-center mb-3">
                                                            <h4 className="font-bold text-gray-800">
                                                                {root} <span className="text-sm text-gray-600">({rootData.volume.toLocaleString()} vol)</span>
                                                            </h4>
                                                            <div className="flex items-center gap-2">
                                                                <label className="text-xs text-gray-600">Split into:</label>
                                                                <input
                                                                    type="number"
                                                                    min="1"
                                                                    max="10"
                                                                    value={config.numCampaigns}
                                                                    onChange={(e) => updateRootConfig(root, 'numCampaigns', e.target.value)}
                                                                    className="w-16 p-1 border border-gray-300 rounded text-sm"
                                                                />
                                                                <span className="text-xs text-gray-600">campaigns</span>
                                                            </div>
                                                        </div>

                                                        <div className="space-y-2">
                                                            {(() => {
                                                                // Simulate the entire assignment process for this root
                                                                let availableKeywords = keywords
                                                                    .filter(kw => kw.roots.includes(root) && kw.campaignId === null && !kw.excluded)
                                                                    .sort((a, b) => b.volume - a.volume);

                                                                // Apply global filters
                                                                if (autoAssignConfig.globalMinVolume) {
                                                                    availableKeywords = availableKeywords.filter(kw => 
                                                                        kw.volume >= parseInt(autoAssignConfig.globalMinVolume)
                                                                    );
                                                                }
                                                                if (autoAssignConfig.globalMaxVolume) {
                                                                    availableKeywords = availableKeywords.filter(kw => 
                                                                        kw.volume <= parseInt(autoAssignConfig.globalMaxVolume)
                                                                    );
                                                                }

                                                                const totalVolume = availableKeywords.reduce((sum, kw) => sum + kw.volume, 0);
                                                                const maxKeywords = autoAssignConfig.globalMaxKeywords 
                                                                    ? parseInt(autoAssignConfig.globalMaxKeywords) 
                                                                    : 999;

                                                                // Track which keywords are assigned and simulate assignment for all campaigns
                                                                const simulatedAssignments = [];
                                                                let keywordIndex = 0;

                                                                config.campaigns.forEach((campaignConfig, campIndex) => {
                                                                    const targetVolume = totalVolume * (campaignConfig.percentage / 100);
                                                                    let currentVolume = 0;
                                                                    let count = 0;

                                                                    // Assign keywords until target volume reached or limits hit
                                                                    while (keywordIndex < availableKeywords.length) {
                                                                        const kw = availableKeywords[keywordIndex];
                                                                        
                                                                        // Stop if we've reached target volume (unless it's the last campaign)
                                                                        if (currentVolume >= targetVolume && campIndex < config.campaigns.length - 1) {
                                                                            break;
                                                                        }

                                                                        // Stop if max keywords limit reached
                                                                        if (count >= maxKeywords) {
                                                                            break;
                                                                        }

                                                                        currentVolume += kw.volume;
                                                                        count++;
                                                                        keywordIndex++;
                                                                    }

                                                                    simulatedAssignments.push({
                                                                        count: count,
                                                                        volume: currentVolume
                                                                    });
                                                                });

                                                                // Now render the campaigns with the simulation results
                                                                return config.campaigns.map((campaign, index) => {
                                                                    const simulation = simulatedAssignments[index] || { count: 0, volume: 0 };
                                                                    const targetVolume = totalVolume * (campaign.percentage / 100);

                                                                    return (
                                                                        <div key={index} className="grid grid-cols-2 gap-3 p-2 bg-gray-50 rounded">
                                                                            <div>
                                                                                <label className="block text-xs text-gray-600 mb-1">Campaign Name</label>
                                                                                <input
                                                                                    type="text"
                                                                                    value={campaign.name}
                                                                                    onChange={(e) => updateCampaignConfig(root, index, 'name', e.target.value)}
                                                                                    className="w-full p-2 border border-gray-300 rounded text-sm"
                                                                                />
                                                                            </div>
                                                                            <div>
                                                                                <label className="block text-xs text-gray-600 mb-1">Volume % (of {rootData.volume.toLocaleString()})</label>
                                                                                <div className="flex items-center gap-2">
                                                                                    <input
                                                                                        type="number"
                                                                                        min="0"
                                                                                        max="100"
                                                                                        value={campaign.percentage}
                                                                                        onChange={(e) => updateCampaignConfig(root, index, 'percentage', e.target.value)}
                                                                                        className="flex-1 p-2 border border-gray-300 rounded text-sm"
                                                                                    />
                                                                                    <span className="text-sm font-semibold">%</span>
                                                                                    <div className="text-xs text-gray-600 text-right">
                                                                                        <div className="font-semibold">~{Math.round(targetVolume).toLocaleString()} target</div>
                                                                                        <div className={`font-semibold ${simulation.count > 0 ? 'text-purple-600' : 'text-gray-400'}`}>
                                                                                            {simulation.count} kw (~{simulation.volume.toLocaleString()} vol)
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                });
                                                            })()}
                                                            <div className="text-xs text-gray-600 mt-1">
                                                                Total: {config.campaigns.reduce((sum, c) => sum + c.percentage, 0)}% 
                                                                {config.campaigns.reduce((sum, c) => sum + c.percentage, 0) !== 100 && (
                                                                    <span className="text-orange-600 ml-2">âš ï¸ Should equal 100%</span>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}

                                    {/* Configuration for Root Groups */}
                                    {autoAssignConfig.rootGroups.length > 0 && (
                                        <div className="space-y-4 mb-6">
                                            <h3 className="text-sm font-bold text-gray-800">Campaign Configuration for Root Groups</h3>
                                            {autoAssignConfig.rootGroups.map(group => {
                                                const groupKeywords = keywords
                                                    .filter(kw => 
                                                        !kw.excluded && 
                                                        kw.campaignId === null &&
                                                        kw.roots.some(root => group.roots.has(root))
                                                    )
                                                    .sort((a, b) => b.volume - a.volume);
                                                
                                                // Apply global filters
                                                let availableKeywords = [...groupKeywords];
                                                if (autoAssignConfig.globalMinVolume) {
                                                    availableKeywords = availableKeywords.filter(kw => 
                                                        kw.volume >= parseInt(autoAssignConfig.globalMinVolume)
                                                    );
                                                }
                                                if (autoAssignConfig.globalMaxVolume) {
                                                    availableKeywords = availableKeywords.filter(kw => 
                                                        kw.volume <= parseInt(autoAssignConfig.globalMaxVolume)
                                                    );
                                                }
                                                
                                                const totalVolume = availableKeywords.reduce((sum, kw) => sum + kw.volume, 0);
                                                const maxKeywords = autoAssignConfig.globalMaxKeywords 
                                                    ? parseInt(autoAssignConfig.globalMaxKeywords) 
                                                    : 999;

                                                return (
                                                    <div key={group.id} className="border-2 border-teal-500 rounded-lg p-4 bg-teal-50">
                                                        <div className="flex justify-between items-center mb-3">
                                                            <h4 className="font-bold text-gray-800">
                                                                {group.name} <span className="text-sm text-gray-600">({totalVolume.toLocaleString()} vol)</span>
                                                            </h4>
                                                            <div className="flex items-center gap-3">
                                                                <button
                                                                    onClick={() => {
                                                                        const updatedGroups = autoAssignConfig.rootGroups.map(g => {
                                                                            if (g.id === group.id) {
                                                                                return {
                                                                                    ...g,
                                                                                    campaigns: [...g.campaigns, {
                                                                                        name: `${g.name} Campaign ${g.campaigns.length + 1}`,
                                                                                        percentage: 0
                                                                                    }]
                                                                                };
                                                                            }
                                                                            return g;
                                                                        });
                                                                        setAutoAssignConfig({
                                                                            ...autoAssignConfig,
                                                                            rootGroups: updatedGroups
                                                                        });
                                                                    }}
                                                                    className="px-3 py-1 bg-teal-600 text-white rounded text-sm font-semibold hover:bg-teal-700"
                                                                >
                                                                    + Add Campaign
                                                                </button>
                                                                <button
                                                                    onClick={() => {
                                                                        if (group.campaigns.length > 1) {
                                                                            const updatedGroups = autoAssignConfig.rootGroups.map(g => {
                                                                                if (g.id === group.id) {
                                                                                    return { ...g, campaigns: g.campaigns.slice(0, -1) };
                                                                                }
                                                                                return g;
                                                                            });
                                                                            setAutoAssignConfig({
                                                                                ...autoAssignConfig,
                                                                                rootGroups: updatedGroups
                                                                            });
                                                                        }
                                                                    }}
                                                                    className="px-3 py-1 bg-gray-300 text-gray-700 rounded text-sm hover:bg-gray-400"
                                                                >
                                                                    - Remove
                                                                </button>
                                                                <div className="text-xs text-gray-600 flex items-center gap-2">
                                                                    <span>Split into:</span>
                                                                    <input
                                                                        type="number"
                                                                        min="1"
                                                                        max="10"
                                                                        value={group.campaigns.length}
                                                                        onChange={(e) => {
                                                                            const newCount = parseInt(e.target.value) || 1;
                                                                            const updatedGroups = autoAssignConfig.rootGroups.map(g => {
                                                                                if (g.id === group.id) {
                                                                                    const newCampaigns = Array.from({ length: newCount }, (_, i) => ({
                                                                                        name: g.campaigns[i]?.name || `${g.name} Campaign ${i + 1}`,
                                                                                        percentage: g.campaigns[i]?.percentage || 0
                                                                                    }));
                                                                                    return { ...g, campaigns: newCampaigns };
                                                                                }
                                                                                return g;
                                                                            });
                                                                            setAutoAssignConfig({
                                                                                ...autoAssignConfig,
                                                                                rootGroups: updatedGroups
                                                                            });
                                                                        }}
                                                                        className="w-16 p-1 border border-gray-300 rounded text-sm text-center"
                                                                    />
                                                                    <span>campaigns</span>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div className="space-y-2">
                                                            {(() => {
                                                                // Simulate assignment for this group
                                                                const simulatedAssignments = [];
                                                                let keywordIndex = 0;

                                                                group.campaigns.forEach((campaignConfig, campIndex) => {
                                                                    const targetVolume = totalVolume * (campaignConfig.percentage / 100);
                                                                    let currentVolume = 0;
                                                                    let count = 0;

                                                                    while (keywordIndex < availableKeywords.length) {
                                                                        const kw = availableKeywords[keywordIndex];
                                                                        
                                                                        if (currentVolume >= targetVolume && campIndex < group.campaigns.length - 1) {
                                                                            break;
                                                                        }

                                                                        if (count >= maxKeywords) {
                                                                            break;
                                                                        }

                                                                        currentVolume += kw.volume;
                                                                        count++;
                                                                        keywordIndex++;
                                                                    }

                                                                    simulatedAssignments.push({ count, volume: currentVolume });
                                                                });

                                                                return group.campaigns.map((campaign, index) => {
                                                                    const simulation = simulatedAssignments[index] || { count: 0, volume: 0 };
                                                                    const targetVolume = totalVolume * (campaign.percentage / 100);

                                                                    return (
                                                                        <div key={index} className="grid grid-cols-2 gap-3 p-2 bg-white rounded">
                                                                            <div>
                                                                                <label className="block text-xs text-gray-600 mb-1">Campaign Name</label>
                                                                                <input
                                                                                    type="text"
                                                                                    value={campaign.name}
                                                                                    onChange={(e) => {
                                                                                        const updatedGroups = autoAssignConfig.rootGroups.map(g => {
                                                                                            if (g.id === group.id) {
                                                                                                const newCampaigns = [...g.campaigns];
                                                                                                newCampaigns[index] = { ...newCampaigns[index], name: e.target.value };
                                                                                                return { ...g, campaigns: newCampaigns };
                                                                                            }
                                                                                            return g;
                                                                                        });
                                                                                        setAutoAssignConfig({
                                                                                            ...autoAssignConfig,
                                                                                            rootGroups: updatedGroups
                                                                                        });
                                                                                    }}
                                                                                    className="w-full p-2 border border-gray-300 rounded text-sm"
                                                                                />
                                                                            </div>
                                                                            <div>
                                                                                <label className="block text-xs text-gray-600 mb-1">Volume % (of {totalVolume.toLocaleString()})</label>
                                                                                <div className="flex items-center gap-2">
                                                                                    <input
                                                                                        type="number"
                                                                                        min="0"
                                                                                        max="100"
                                                                                        value={campaign.percentage}
                                                                                        onChange={(e) => {
                                                                                            const updatedGroups = autoAssignConfig.rootGroups.map(g => {
                                                                                                if (g.id === group.id) {
                                                                                                    const newCampaigns = [...g.campaigns];
                                                                                                    newCampaigns[index] = { ...newCampaigns[index], percentage: e.target.value };
                                                                                                    return { ...g, campaigns: newCampaigns };
                                                                                                }
                                                                                                return g;
                                                                                            });
                                                                                            setAutoAssignConfig({
                                                                                                ...autoAssignConfig,
                                                                                                rootGroups: updatedGroups
                                                                                            });
                                                                                        }}
                                                                                        className="flex-1 p-2 border border-gray-300 rounded text-sm"
                                                                                    />
                                                                                    <span className="text-sm font-semibold">%</span>
                                                                                    <div className="text-xs text-gray-600 text-right">
                                                                                        <div className="font-semibold">~{Math.round(targetVolume).toLocaleString()} target</div>
                                                                                        <div className={`font-semibold ${simulation.count > 0 ? 'text-teal-600' : 'text-gray-400'}`}>
                                                                                            {simulation.count} kw (~{simulation.volume.toLocaleString()} vol)
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    );
                                                                });
                                                            })()}
                                                            <div className="text-xs text-gray-600 mt-1">
                                                                Total: {group.campaigns.reduce((sum, c) => sum + (parseFloat(c.percentage) || 0), 0)}% 
                                                                {group.campaigns.reduce((sum, c) => sum + (parseFloat(c.percentage) || 0), 0) !== 100 && (
                                                                    <span className="text-orange-600 ml-2">âš ï¸ Should equal 100%</span>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}

                                    {/* Action Buttons */}
                                    <div className="flex justify-end gap-3 pt-4 border-t border-gray-300">
                                        <button
                                            onClick={() => setShowAutoAssign(false)}
                                            className="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50"
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            onClick={executeAutoAssign}
                                            className="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-bold hover:from-purple-700 hover:to-blue-700"
                                            disabled={autoAssignConfig.selectedRoots.size === 0 && autoAssignConfig.rootGroups.length === 0}
                                        >
                                            ðŸš€ Execute Auto-Assign
                                        </button>
                                    </div>

                                    {/* Help Text */}
                                    <div className="mt-4 p-3 bg-gray-50 rounded text-xs text-gray-600">
                                        <strong>How it works:</strong> Keywords are sorted by volume (highest first). Each campaign receives keywords until its target volume percentage is reached. The first campaign typically has fewer keywords but the highest volume.
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Restore Previous Session Dialog */}
                    {showRestoreDialog && (
                        <div className="modal-overlay" onClick={(e) => {
                            if (e.target === e.currentTarget) {
                                clearSavedState();
                            }
                        }}>
                            <div className="modal-content max-w-md" onClick={(e) => e.stopPropagation()}>
                                <div className="p-6">
                                    <div className="text-center mb-6">
                                        <div className="text-4xl mb-3">ðŸ’¾</div>
                                        <h2 className="text-2xl font-bold text-gray-800 mb-2">
                                            Previous Session Found
                                        </h2>
                                        <p className="text-gray-600">
                                            Would you like to restore your last setup with all keywords and settings?
                                        </p>
                                    </div>

                                    <div className="flex gap-3">
                                        <button
                                            onClick={clearSavedState}
                                            className="flex-1 px-6 py-3 border-2 border-gray-300 rounded-lg text-gray-700 font-semibold hover:bg-gray-50"
                                        >
                                            No, Start Fresh
                                        </button>
                                        <button
                                            onClick={loadState}
                                            className="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-bold hover:from-purple-700 hover:to-blue-700"
                                        >
                                            Yes, Restore
                                        </button>
                                    </div>

                                    <p className="text-xs text-gray-500 text-center mt-4">
                                        Your data is stored locally in your browser
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<PPCCampaignBuilderV7 />, document.getElementById('root'));
    </script>
</body>
</html>
